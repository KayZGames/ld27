import "dart:web_audio" as tB;import "dart:math" as JD;import "dart:json" as fF;import "dart:html" as sB;import "dart:async" as YB;import "dart:typed_data" as KD;class gF{static const  hF="Chrome";static const  iF="Firefox";static const  jF="Internet Explorer";static const  kF="Safari";final  rE;final  minimumVersion;const gF(this.rE,[this.minimumVersion]);}class lF{const lF();}class mF{final  name;const mF(this.name);}class nF{const nF();}class oF{const oF();} main(){sB.window.setImmediate((){var g=sB.query('canvas');g.width=cB;g.height=UB;YB.Future.wait([VD('../assets/img/assets'),XE('../assets/img/assets')]).then((i){var h=new JE(g,new mC(i[0]),i[1]);h.GF();sB.window.requestAnimationFrame(h.IF);});});}class JE{var canvas;var sheet;var dB;var WB;var xC=0;var l=new uB();JE(this.canvas,this.sheet,this.dB); GF(){HF();dB.forEach((g,u){var m=sheet.vC('${g}.png').JC['${g}.png'].offset;u.forEach((i){i.XB=i.XB.map((hB)=>hB+m).toList();});});var h=new PD();l.RC(h);l.RC(new NC());var IB=KB(l,[new BB.MG(cB/2.0,UB-100.0,0.0),new wB(0.0,0.0),new lB('ship_0')]);KB(l,[new BB.MG(cB/2.0,UB-165.0,0.0),new wB(0.0,0.0),new nC(1,500.0)],player:QC);h.register(IB,QC);l.JB(new pF(canvas));l.JB(new wF());l.JB(new tF(dB));l.JB(new CG());l.JB(new AG());l.JB(new yF());l.JB(new uF());l.JB(new vF());l.JB(new xF());l.JB(new zF());l.JB(new sF());l.JB(new BG());l.JB(new UD(WB));l.JB(new WD(canvas.context2D,sheet));l.JB(new qF(canvas.context2D,sheet));l.initialize();new YB.Timer(new Duration(seconds:10),(){VD('../assets/img/assetsv1').then((NB){sheet.add(NB);var iB=l.qD(WD);iB.AE(1);});});new YB.Timer(new Duration(seconds:20),(){var o=l.qD(UD);o.nE();});} IF( g){l.RB=16.66;xC=g;l.process();sB.window.requestAnimationFrame(update);} update( g){l.RB=g-xC;xC=g;l.process();sB.window.requestAnimationFrame(update);} HF(){WB=ZE();var i=new sB.AudioElement();var g='ogg';var m=['probably','maybe'];if(m.contains(i.canPlayType('audio/ogg'))){g='ogg';}else if(m.contains(i.canPlayType('audio/mpeg; codecs="mp3"'))){g='mp3';}else if(m.contains(i.canPlayType('audio/mp3'))){g='mp3';}for(int h=0;h<qC;h++ ){WB.cC('explosion_${h}','explosion_${h}.${g}').load();}WB.cC('shoot_0','shoot_0.${g}').load();WB.cC('collision_0','collision_0.${g}').load();}}class KE{static  LE( g){var IB=0,o=0,NB=0,u=0,m=0,i=0;var h=g.currentTarget;do{IB+= h.offset.left;o+= h.offset.top;}while(null!=(h=h.offsetParent));if(null!=g.page.x||null!=g.page.y){m=g.page.x;i=g.page.y;}else if(g is sB.MouseEvent){if(null!=g.client.x||null!=g.client.y){m=g.client.x+sB.document.body.scrollLeft+sB.document.documentElement.scrollLeft;i=g.client.y+sB.document.body.scrollTop+sB.document.documentElement.scrollTop;}}NB=m-IB;u=i-o;return new sB.Point(NB,u);}}class jB{static var kC=1;static var NE=0;var WG=0;var YG=0;jB(){WG=kC;kC=kC<<1;YG=NE++ ;} get VC=>WG; get id=>YG;}class KC{static var ND=new Map<Type,jB>();static  MC( h){var g=ND[h];if(g==null){g=new jB();ND[h]=g;}return g;}static  QE( g)=>MC(g).VC;}class ME{static var MD=0;static var LC;static  OE( h){if(null==LC){LC=new Map<Type,int>();}var g=LC[h];if(g==null){g=1<<MD;MD++ ;LC[h]=g;}return g;}}class iC extends SB{var SG;var UG;var aG;var bG=0;var cG=0;var dG=0;var XG=0;var kG;iC():SG=new q<k>(),UG=new q<k>(),aG=new q<bool>(),kG=new VE(); initialize(){} GH(){var g=UG.removeLast();if(null==g){g=new k.JG(VG,kG.uE());}dG++ ;return g;} SC( g){bG++ ;cG++ ;SG[g.id]=g;} enabled( g){aG[g.id]=false;} disabled( g){aG[g.id]=true;} eB( g){SG[g.id]=null;aG[g.id]=false;UG.add(g);bG-- ;XG++ ;} isActive( g)=>SG[g]!=null; XH( g)=>SG[g];}abstract class LD{ SC( g); tC( g); eB( g); enabled( g); disabled( g);}class jC extends SB{var TG;var XG;jC():TG=new q<q<t>>(),XG=new q<k>(); initialize(){} pG( g){tG(g,(h,i){h[g.id].sG();h[g.id]=null;});g.yG=0;} DH( i, m, o){var h=m.id;TG.JH(h);var g=TG[h];if(g==null){g=new q<t>();TG[h]=g;}g[i.id]=o;i.OH(m.VC);} PH( g, h){if((g.yG&h.VC)!=0){var i=h.id;TG[i][g.id].sG();TG[i][g.id]=null;g.RH(h.VC);}} CF( i){var h=i.id;TG.JH(h);var g=TG[h];if(g==null){g=new q<t>();TG[h]=g;}return g;} tG( i, m( components, index)){var g=i.yG;var h=0;while (g>0){if((g&1)==1){m(TG[h],h);}h++ ;g=g>>1;}} eB( g)=>XG.add(g); vE(){XG.forEach((g)=>pG(g));XG.clear();}}abstract class SB implements LD{var VG; initialize(); SC( g){} tC( g){} eB( g){} disabled( g){} enabled( g){}}class ZB<PB>{var ZG;ZB.IG(this.ZG); operator[]( g)=>ZG[g]; get size=>ZG.size; get isEmpty=>ZG.isEmpty; contains( g)=>ZG.contains(g); forEach( g( element))=>ZG.forEach(g);}class k{final  id;var wG=0;var yG=0;var LC=0;var VG;var rG;var vG;k.JG(this.VG,this.id){rG=VG.AF;vG=VG.hD;} OH( g){yG|= g;} RH( g){yG&= ~g;} UH( g){LC|= g;} VH( g){LC&= ~g;} toString()=>"Entity[${id}]"; nB( g){vG.DH(this,KC.MC(g.runtimeType),g);} BE( g){vG.PH(this,KC.MC(g));} get sC=>rG.isActive(id); XC()=>VG.yE(this); zB()=>VG.tE(this);}abstract class OB extends TB{OB( g):super(g); MB( g); IC( h)=>h.forEach((g)=>MB(g)); AC()=>true;}abstract class PE extends TB{var gG=0;var lG=0;final  nG; get RB=>lG;PE(this.nG, g):super(g); AC(){gG+= l.RB;lG+= l.RB;if(gG>=nG){gG-= nG;return true;}return false;} end(){lG=0;}}class EB<OC extends t>{var iG;var mG;EB( h, g){this.iG=KC.MC(h);mG=g.hD.CF(this.iG);}OC get( g)=>mG[g.id] as OC; pD( g){if(mG.LF(g.id)){return mG[g.id] as OC;}return null;}}class NC extends SB{var hG;var oG;NC(){hG=new Map<k,String>();oG=new Map<String,q<k>>();} XF( i, h){hG[i]=h;var g=oG[h];if(g==null){g=new q<k>();oG[h]=g;}g.add(i);} DF( h){var g=oG[h];if(g==null){g=new q<k>();}return g.readOnly;} UF( g){var h=hG[g];if(h!=null){var i=oG[h];if(i!=null){i.remove(g);}}} initialize(){} eB( g)=>UF(g);}class q<PB>{var eG;var fG=0;var jG;q({ capacity: 16}):eG=new List(capacity){jG=new ZB.IG(this);} operator[]( g)=>eG[g]; get size=>fG; get readOnly=>jG; get isEmpty=>fG==0; forEach( h( element)){for(int g=0;g<fG;g++ ){h(eG[g]);}} removeLast(){if(fG>0){var g=eG[ --fG];eG[fG]=null;return g;}return null;} remove( i){for(int g=0;g<fG;g++ ){var h=eG[g];if(i==h){eG[g]=eG[ --fG];eG[fG]=null;return true;}}return false;} contains( h){for(int g=0;fG>g;g++ ){if(h==eG[g]){return true;}}return false;} get sE=>eG.length; add( g){if(fG==eG.length){eH();}eG[fG++ ]=g;} operator[]=( g, h){if(g>=eG.length){fH(g*2);}if(fG<=g){fG=g+1;}eG[g]=h;} eH(){var g=((eG.length*3)/2+1).toInt();fH(g);} fH( h){var g=eG;eG=new List<PB>(h);eG.setRange(0,g.length,g);} JH( g){if(g>=eG.length){fH(g*2);}} clear(){for(int g=0;g<fG;g++ ){eG[g]=null;}fG=0;} LF( g)=>g<sE; toString()=>"[${eG.join(',')}]";}class OD{static var lC=new Map<Type,q<aB>>();static aB RE( i, m){var h=TE(i);var g=h.removeLast();if(null==g){g=m();}return g;}static  TE( h){var g=lC[h];if(null==g){g=new q();lC[h]=g;}return g;}static  UE( g){lC[g.runtimeType].add(g);}}abstract class t{ sG(){}}class PD extends SB{final  qG;final  uG;PD():qG=new Map<String,k>(),uG=new Map<k,String>(); register( g, h){qG[h]=g;uG[g]=h;} unregister( g){uG.remove(qG.remove(g));} oD( g)=>qG[g]; eB( h){var g=uG.remove(h);if(g!=null){qG.remove(g);}} initialize(){}}abstract class QD extends TB{QD():super(AB.TD()); IC( g)=>AD(); AD(); AC()=>true;}class uB{final  rG=new iC();final  vG=new jC();final  cG=new q<k>();final  BH=new q<k>();final  XG=new q<k>();final  IH=new q<k>();final  KH=new q<k>();final  LH=new Map<Type,TB>();final  MH=new List<TB>();final  NH=new Map<Type,SB>();final  QH=new q<SB>();var RB=0;var SH=0;var TH=0.0; get DC=>SH; get time=>TH;uB(){RC(rG);RC(vG);} initialize(){QH.forEach((h)=>h.initialize());MH.forEach((g)=>g.initialize());} get AF=>rG; get hD=>vG; RC( g){NH[g.runtimeType]=g;QH.add(g);g.VG=this;} aC( g){return NH[g];} xE(){return rG.GH();} oD( g){return rG.XH(g);} JB( g,{ passive: false}){g.l=this;g.HH=passive;LH[g.runtimeType]=g;MH.add(g);return g;} qD( g){return LH[g];} YH( i, h(EntityObserver,Entity)){i.forEach((g){QH.forEach((m)=>h(m,g));MH.forEach((o)=>h(o,g));});i.clear();} process(){SH++ ;TH+= RB;TF();MH.forEach((g){if(!g.PF){g.process();}});} TF(){YH(cG,(h,g)=>h.SC(g));YH(BH,(h,g)=>h.tC(g));YH(KH,(h,g)=>h.disabled(g));YH(IH,(h,g)=>h.enabled(g));YH(XG,(h,g)=>h.eB(g));vG.vE();} oE( g)=>cG.add(g); tE( g)=>BH.add(g); yE( g){if(!XG.contains(g)){XG.add(g);}}}class RD extends SB{}abstract class TB implements LD{var xG=0;var l;var zG;var AH;var CH;var EH;var FH;var HH;TB( g):zG=new q<k>(),AH=g.pE,CH=g.BF,EH=g.OF{FH=AH==0&&EH==0;xG=ME.OE(runtimeType);}get PF=>HH; eD(){} process(){if(AC()){eD();IC(zG.readOnly);end();}} end(){} IC( g); AC(); initialize(){} JF( g){} VF( g){} YH( g){if(FH){return;}var i=ZH(g);var h=(AH&g.yG)==AH;if(EH>0&&h){h=(EH&g.yG)>0;}if(CH>0&&h){h=(CH&g.yG)==0;}if(h&&!i){cH(g);}else if(!h&&i){dH(g);}} ZH( g)=>(xG&g.LC)==xG; cH( g){zG.add(g);g.UH(xG);JF(g);} dH( g){zG.remove(g);g.VH(xG);VF(g);} SC( g)=>YH(g); tC( g)=>YH(g); enabled( g)=>YH(g); eB( g){if(ZH(g)){dH(g);}} disabled( g){if(ZH(g)){dH(g);}}}class SE extends t with aB{ sG(){NF();} fD(){}}class AB{var AH=0;var CH=0;var EH=0; qE( g){AH=WH(AH,g);return this;} nD( g){CH=WH(CH,g);return this;}static  LB( h){var g=new AB();g.qE(h);return g;}static  TD()=>new AB(); get pE=>AH; get BF=>CH; get OF=>EH; WH( g, h){if(null!=h){h.forEach((i){g=g|KC.QE(i);});}return g;}}typedef  SD();abstract class aB{factory aB.KG( g, h){return OD.RE(g,h);} fD(); NF(){fD();OD.UE(this);}}class VE{var aH;var bH=0;VE():aH=new q<int>(); uE(){if(aH.size>0){return aH.removeLast();}return bH++ ;}}class BB extends SE{var HC;var BD;var WF;var gH=new CB.RG(); get angle=>BD.z;set angle( g)=>BD.z=g; get position{gH.x=HC.x;gH.y=HC.y;return gH;}set position( g){HC.x=g.x;HC.y=g.y;}BB.LG();static WE()=>new BB.LG();factory BB.MG( i, g, h){return new BB.NG(new FB(i,g,0.0),new FB(0.0,0.0,h));}factory BB.NG( m,[ h, i]){var g=new aB.KG(BB,WE) as BB;g.HC=m;g.BD=(h==null)?new FB(0.0,0.0,0.0):h;g.WF=(i==null)?new FB(1.0,1.0,1.0):i;return g;}}KB(h, u,{ player, groups}){var g=h.xE();u.forEach((i)=>g.nB(i));if(groups!=null){var o=(h.aC(RD) as RD);groups.forEach((m)=>o.add(g,m));}if(player!=null){(h.aC(NC) as NC).XF(g,player);}h.oE(g);return g;}class qF extends OB{var DB;var oB;var context;var sheet;qF(this.context,this.sheet):super(AB.LB([BB,lB])); initialize(){DB=new EB<BB>(BB,l);oB=new EB<lB>(lB,l);} MB( h){var IB=DB.get(h);var m=oB.get(h);var o=IB.position;var u='${m.yB}.png';var i=sheet.vC(u);var g=i.JC['${m.yB}.png'];context.drawImageToRect(i.wC,new sB.Rect(o.x+g.CC.left,o.y+g.CC.top,g.CC.width,g.CC.height),sourceRect:g.src);}}class pF extends QD{var canvas;var zC;var yD;var FE;var rB;var DB;pF(this.canvas); initialize(){yD=l.aC(NC);FE=l.aC(PD);rB=new EB<wB>(wB,l);DB=new EB<BB>(BB,l);canvas.onMouseMove.listen(FF);} AD(){if(null!=zC){var m=FE.oD(QC);var g=rB.get(m);var u=DB.get(m).position;var i=u.x-zC.x;if(i>5){g.angle=JD.PI/2;g.abs=0.25;}else if(i<-5){g.angle=-JD.PI/2;g.abs=0.25;}else{g.angle=0.0;g.abs=0.0;}yD.DF(QC).forEach((o){var h=rB.pD(o);if(null!=h){h.abs=g.abs;h.angle=g.angle;}});}} FF( g){zC=KE.LE(g);}}class UD extends OB{var CE;var WB;var sC=false;UD(this.WB):super(AB.LB([rC]));initialize(){CE=new EB<rC>(rC,l);}MB( g){if(sC){var h=CE.get(g);WB.xD('default',h.gD);}g.XC();} nE(){sC=true;}} XE( g){return sB.HttpRequest.getString('${g}.polygons.json').then(YD).then(YE);} YE( u){var g=new Map<String,List<kB>>();u.forEach((m,o){var h=new List<kB>();o.forEach((i)=>h.add(new kB(i['shape'])));g[m]=h;});return new YB.Future.value(g);} ZE(){var m=sB.window.location.href.lastIndexOf('/web/');var h=sB.window.location.href.substring(0,m)+'/assets/sfx/';var g;try {if(null==new tB.AudioContext().createBufferSource().gain)throw 'this ain\'t no real AudioContext';g=new VB(h);var i=g.MF('default');i.zD=false;}catch (o){g=new rF(h);}return g;} VD( g){return sB.HttpRequest.getString('${g}.json').then(YD).then((h)=>aE(g,h));} aE( u, IB){var h=new YB.Completer<bB>();var g=new sB.ImageElement();g.onLoad.listen((hH){var i=new Map<String,bE>();IB['frames'].forEach((o,NB){i[o]=new bE(NB);});var m=new bB(g,i);h.complete(m);});g.src='${u}.png';return h.future;}class rF implements VB{var baseURL;rF([this.baseURL='/']);var iH=new Map<String,cE>(); cC( h, i){var g=iH[h];if(g!=null){return g;}g=new cE.OG(this,h,"${baseURL}${i}");iH[h]=g;return g;} xD( h, g,[ i=false]){iH[g].play();return null;} noSuchMethod( g){}}class mC{var fC;mC( g){fC=new List<bB>();fC.add(g);} add( g)=>fC.insert(0,g); vC( g)=>fC.where((h)=>h.JC.containsKey(g)).first;}class bB{final  wC;final  JC;bB(this.wC,this.JC);}class bE{var src;var CC;var offset;bE( o){var g=new dE(o);var h=g.DC;var i,m;if(g.HE){i=-(g.DD.w~/2-g.ED.x);m=-(g.DD.fB~/2-g.ED.y);}else{i=-g.DC.w~/2;m=-g.DC.fB~/2;}src=new sB.Rect(h.x,h.y,h.w,h.fB);CC=new sB.Rect(i,m,h.w,h.fB);offset=new CB(i.toDouble(),m.toDouble());}}class WD extends QD{var UC;var context;var sheet;WD(this.context,this.sheet); initialize(){UC=new sB.CanvasElement(width:cB,height:UB);AE(16);} eD(){context.save();} AD(){context.drawImage(UC,0,(l.time/20)%UB);context.drawImage(UC,0,(l.time/20)%UB-UB+1);} end(){context.restore();} AE( o){var i=UC.context2D;i.clearRect(0,0,cB,UB);var m=sheet.vC('bg_rect_0.png');for(int g=0;g<UB/16;g++ ){for(int h=0;h<cB/16;h++ ){i.drawImageToRect(m.wC,new sB.Rect(h*16,g*16,16,16),sourceRect:m.JC['bg_rect_${GB.nextInt(o)}.png'].src);}}}}class cE implements HB{final  jH;var kH;var lH;var TC=new List<sB.AudioElement>();cE.OG(this.jH,this.kH,this.lH); load(){var g=new sB.AudioElement();var h=new YB.Completer<HB>();g.onCanPlay.first.then((hH){h.complete(this);});g.src=lH;TC.add(g);return h.future;} play(){var h=TC.where((i)=>i.ended).iterator;var g;if(h.moveNext()){g=h.current;}else{g=TC[0].clone(false);TC.add(g);}g.play();} noSuchMethod( g){}}class dE{var DC;var HE;var ED;var DD;dE( g):DC=new XD(g["frame"]),HE=g["trimmed"],ED=new XD(g["spriteSourceSize"]),DD=new eE(g["sourceSize"]);}class XD{var x,y,w,fB;XD( g):x=g["x"].toInt(),y=g["y"].toInt(),w=g["w"].toInt(),fB=g["h"].toInt();}class eE{var w,fB;eE( g):w=g["w"].toInt(),fB=g["h"].toInt();} YD( g){return new YB.Future.value(fF.parse(g));}class nC extends t{var iD;var jD;nC(this.jD,this.iD);}class tF extends TB{var DB;var oB;var lD;var dB;tF(this.dB):super(AB.LB([BB,lB]).nD([fE])); initialize(){DB=new EB<BB>(BB,l);oB=new EB<lB>(lB,l);lD=new EB<ZD>(ZD,l);} IC( i){var hB=i.size;if(hB>1){for(int m=0;m<i.size-1;m++ ){for(int o=m+1;o<i.size;o++ ){var g=i[m];var h=i[o];var hC=DB.get(g).position;var NB=DB.get(h).position;var ID=oB.get(g).yB;var u=oB.get(h).yB;var IB=dB[ID];var iB=dB[u];if(zE(IB,hC,iB,NB)){g.nB(new aD());h.nB(new aD());GE(g,h);GE(h,g);g.zB();h.zB();}}}}} GE(h,i){var g=lD.pD(h);if(null!=g){i.nB(new PC(g.value));}} zE( ID, u, aF, bF){var g=true;aF.forEach((cF){g=false;ID.where((mH)=>!g).forEach((hB){g=true;var hC=hB.XB.last;hB.XB.forEach((iB){var IB=EF(hC+u,iB+u);var m=(iB+u).ZC(IB);var NB=m;hB.XB.sublist(1).forEach((dF){var h=(dF+u).ZC(IB);m=JD.min(m,h);NB=JD.max(NB,h);});var i;var o;var HG=true;cF.XB.forEach((eF){var h=(eF+bF).ZC(IB);if(null==i){i=h;o=h;}i=JD.min(i,h);o=JD.max(o,h);});if(NB<i||m>o){g=false;return;}hC=iB;});if(g){return;}});if(g){return;}});return g;} EF( h, i){var g=new CB(-h.y+i.y,h.x-i.x);g.normalize();return g;} AC()=>true;}class uF extends OB{var cm;uF():super(AB.LB([vB])); initialize(){cm=new EB<vB>(vB,l);} MB( g){var h=cm.get(g);h.value-= l.RB;if(h.value<0.0){g.BE(vB);g.zB();}}}class sF extends OB{var rD;var DB;sF():super(AB.LB([nC,BB]).nD([vB])); initialize(){rD=new EB<nC>(nC,l);DB=new EB<BB>(BB,l);} MB( g){var h=rD.get(g);var i=DB.get(g).position;g.nB(new vB(h.iD));g.zB();KB(l,[new BB.MG(i.x,i.y,0.0),new wB(0.4,0.0),new lB('bullet_${GB.nextInt(4)}'),new oC(2000.0),new hE(),new gE(),new ZD(h.jD)]);KB(l,[new rC('shoot_0')]);}}class kB{var XB;kB( h){XB=new List(h.length~/2);for(int g=0;g<h.length;g+= 2){XB[g~/2]=new CB(h[g].toDouble(),h[g+1].toDouble());}}}class vB extends t{var value;vB(this.value);}class wB extends t{var abs,angle;wB(this.abs,this.angle);}class oC extends t{var time;oC(this.time);}class lB extends t{var yB;lB(this.yB);}class vF extends OB{var em;vF():super(AB.LB([oC])); initialize(){em=new EB<oC>(oC,l);} MB( h){var g=em.get(h);g.time-= l.RB;if(g.time<0.0){h.XC();}}}class PC extends t{var value;PC(this.value);}class ZD extends t{var value;ZD(this.value);}const cB=600;class pC extends t{var vD,uC;pC(this.vD){uC=vD;}}const UB=720;const QC='player1';const qC=4;var GB=new JD.Random();class rC extends t{final  gD;rC(this.gD);}class fE extends t{}class aD extends t{}class wF extends OB{var DB;var rB;wF():super(AB.LB([BB,wB])); initialize(){DB=new EB<BB>(BB,l);rB=new EB<wB>(wB,l);} MB( i){var m=DB.get(i);var h=rB.get(i);var g=m.position;g.x=g.x-h.abs*JD.sin(h.angle)*l.RB;g.y=g.y-h.abs*JD.cos(h.angle)*l.RB;m.position=g;}}class bD extends t{}class gE extends t{}class xF extends OB{var DB;xF():super(AB.LB([aD,gE,BB])); initialize(){DB=new EB<BB>(BB,l);} MB( h){var g=DB.get(h).position;KB(l,[new BB.MG(g.x,g.y,0.0),new lB('impact_${GB.nextInt(8)}'),new fE(),new oC(50+GB.nextDouble()*100)]);KB(l,[new BB.MG(g.x,g.y,0.0),new lB('impact_${GB.nextInt(8)}'),new fE(),new oC(50+GB.nextDouble()*100)]);KB(l,[new BB.MG(g.x,g.y,0.0),new lB('impact_${GB.nextInt(8)}'),new fE(),new oC(50+GB.nextDouble()*100)]);KB(l,[new rC('collision_0')]);}}class hE extends t{}class iE extends t{}class yF extends OB{var sD;var kD;yF():super(AB.LB([pC,PC])); initialize(){sD=new EB<pC>(pC,l);kD=new EB<PC>(PC,l);} MB( g){var h=sD.get(g);var i=kD.get(g);h.uC-= i.value;g.BE(PC);if(h.uC<=0){g.nB(new bD());}g.zB();}}class zF extends OB{var DB;zF():super(AB.LB([bD,iE,BB])); initialize(){DB=new EB<BB>(BB,l);} MB( h){var g=DB.get(h).position;KB(l,[new BB.MG(g.x,g.y,0.0),new lB('explosion_${GB.nextInt(8)}'),new fE(),new oC(50+GB.nextDouble()*100)]);KB(l,[new BB.MG(g.x,g.y,0.0),new lB('explosion_${GB.nextInt(8)}'),new fE(),new oC(50+GB.nextDouble()*100)]);KB(l,[new BB.MG(g.x,g.y,0.0),new lB('explosion_${GB.nextInt(8)}'),new fE(),new oC(50+GB.nextDouble()*100)]);KB(l,[new rC('explosion_${GB.nextInt(qC)}')]);KB(l,[new rC('explosion_${GB.nextInt(qC)}')]);}}class AG extends OB{AG():super(AB.LB([bD])); MB( g)=>g.XC();}class BG extends PE{BG():super(2000,AB.TD()); IC(mH){KB(l,[new BB.MG(GB.nextDouble()*cB,-20.0,0.0),new wB(0.1,-JD.PI),new lB('truck_0'),new pC(3),new iE(),new oC(10000.0)]);}}class CG extends OB{CG():super(AB.LB([aD,hE])); MB( g){g.XC();}}class jE{final  nH;var oH;var pH;var qH;jE.PG(this.nH, g){oH=new mB.PG(nH,'music',g);oH.zD=false;} HI(){if(pH!=null){pH.stop();pH=null;}} get pause=>pH==null?false:pH.pause; set pause( g){if(pH!=null){pH.pause=g;}} play({loop: true}){HI();pH=new QB.PG(oH,qH,loop);pH.play();} stop(){HI();}}class cD{var HD=0;var xB=0.0;var gB=0.0;var EE=0.0;var BC=0.0;var FD=0.3;var dC=0.0;var gC=0.0;var YC=0.0;var IE=0.0;var GD=0.0;var pB=0.0;var WC=0.0;var DE=0.0;var mD=0.0;var eC=0.0;var FC=0.0;var GC=0.0;var qB=0.0;var uD=0.0;var yC=0.0;var bC=0.0;var tD=0.0;var EC=0.0;cD.QG( m){var g=m.split(",");this.HD=kE(g[0]);this.xB=v(g[1]);this.gB=v(g[2]);this.EE=v(g[3]);this.BC=v(g[4]);this.FD=v(g[5]);this.dC=v(g[6]);this.gC=v(g[7]);this.YC=v(g[8]);this.IE=v(g[9]);this.GD=v(g[10]);this.pB=v(g[11]);this.WC=v(g[12]);this.DE=v(g[13]);this.mD=v(g[14]);this.eC=v(g[15]);this.FC=v(g[16]);this.GC=v(g[17]);this.qB=v(g[18]);this.uD=v(g[19]);this.yC=v(g[20]);this.bC=v(g[21]);this.tD=v(g[22]);this.EC=v(g[23]);if(this.gB<.01){this.gB=.01;}var i=this.xB+this.gB+this.BC;if(i<.18){var h=.18/i;this.xB*= h;this.gB*= h;this.BC*= h;}}static  kE( g){if(g==null||g.length==0){return 0;}return int.parse(g,radix:10);}static  v( g){if(g==null||g.length==0){return 0.0;}return double.parse(g);}}class HB{static const dD="sfxr:";final  nH;var rH;var sH; get url=>sH;var tH;var uH=false;var vH='';var xH=false;var AI=false;HB.PG(this.nH,this.rH,this.sH); MI(){xH=false;tH=null;} wE(){uH=false;vH='OK';} dI( g){uH=true;vH=g;} eI( g, h){if(g==null){dI('Error decoding buffer.');h.complete(this);return;}wE();tH=g;xH=true;h.complete(this);} fI( h, g){var i=h.response;nH.DI.decodeAudioData(i).then((m){eI(m,g);}).catchError((o){eI(null,g);});} gI( h, g){dI('Error fetching data');g.complete(this);} load(){if(url==null){dI('No URL set.');return new YB.Future<HB>.value(this);}MI();if(url.startsWith(dD)){return new YB.Future<HB>.delayed(new Duration(milliseconds:1),(){tH=lE.mE(nH.DI,url.substring(dD.length));xH=true;return this;});}var g=new sB.HttpRequest();var h=new YB.Completer<HB>();if(AI){g.open('GET',url);}else{g.open('GET','${nH.baseURL}/${url}');}g.responseType='arraybuffer';g.onLoad.listen((i)=>fI(g,h));g.onError.listen((i)=>gI(g,h));g.onAbort.listen((i)=>gI(g,h));g.send();return h.future;} get length{if(tH==null){return 0;}return tH.duration;}}class QB{final  oH;final  qH;final  wH;var yH;var zH;var BI;var CI; get EI=>yH.gain.value; get isScheduled=>yH==null?false:yH.playbackState==tB.AudioBufferSourceNode.SCHEDULED_STATE; get KF=>yH==null?false:yH.playbackState==tB.AudioBufferSourceNode.FINISHED_STATE;QB.PG(this.oH,this.qH,this.wH){bI();} cI(){if(yH!=null){print('${yH.playbackState}');}} bI(){yH=oH.nH.DI.createBufferSource();if(qH!=null&&qH.tH!=null){yH.buffer=qH.tH;yH.loopStart=0.0;yH.loopEnd=qH.tH.duration;}yH.gain.value=EI;yH.loop=wH;yH.connectNode(oH.LI,0,0);} HI([ g=0.0]){if(yH!=null){yH.stop(g);}yH=null;} get pause=>zH!=null; set pause( g){if(g){if(zH!=null){return;}hI();}else{if(zH==null){return;}iI();}} get time{var g=oH.nH.DI.currentTime;if(zH!=null){return zH;}return jI();} jI(){assert(BI!=null);var g=oH.nH.DI.currentTime;var h=g-BI;if(g<CI){return g-CI;}if(wH){return h%yH.buffer.duration;}return h;} hI([ g=0.0]){if(BI==null){return;}print('Sound.pause');cI();if(yH!=null){zH=jI();HI(g);print('paused at ${zH}');}} iI(){if(zH==null){return;}print('Sound.resume');cI();bI();if(zH<0.0){zH=-zH;print('Scheduling to play sound in ${zH}.');CI=oH.nH.DI.currentTime+zH;yH.start(CI,0.0,yH.buffer.duration);BI=oH.nH.DI.currentTime;}else{print('Starting to play at offset ${zH}');CI=oH.nH.DI.currentTime;yH.start(CI,zH,yH.buffer.duration-zH);BI=oH.nH.DI.currentTime-zH;}zH=null;} play([ g=0.0]){HI();bI();CI=oH.nH.DI.currentTime+g;yH.start(CI);BI=oH.nH.DI.currentTime;} stop(){HI();BI=null;CI=null;zH=null;} get volume=>EI; set volume( g){if(yH!=null){yH.gain.value=g;}}}class VB{var DI;var FI;var GI;var II;var KI;var NI;var baseURL;var SI=new Map<String,HB>();var WI=new Map<String,mB>();var aI;VB([this.baseURL='']){DI=new tB.AudioContext();FI=DI.destination;GI=DI.listener;II=DI.createGain();KI=DI.createGain();NI=DI.createGain();II.connectNode(FI,0,0);KI.connectNode(II,0,0);NI.connectNode(II,0,0);aI=new jE.PG(this,KI);} get EC=>II.gain.value; set EC( g){wD=false;II.gain.value=g;}var RI; set wD( g){if(g){if(RI!=null){return;}RI=II.gain.value;II.gain.value=0;}else{if(RI==null){return;}II.gain.value=RI;RI=null;}}var lI=false;var mI=false; cC( h, i){var g=SI[h];if(g!=null){return g;}g=new HB.PG(this,h,i);SI[h]=g;return g;} MF( h){var g=WI[h];if(g!=null){return g;}g=new mB.PG(this,h,NI);WI[h]=g;return g;} xD( g, h,[ i=false]){return QF(0.0,g,h,i);} QF( m, i, o,[ u=false]){var g=WI[i];if(g==null){print('Could not find source ${i}');return null;}var h=SI[o];if(h==null){print('Could not find clip ${o}');return null;}if(u){return g.RF(m,h);}else{return g.SF(m,h);}}}class mB{var nH;var rH;var JI;var LI;var OI;var QI;var RI;var TI=false;var UI=0.0;var VI=0.0;var XI=0.0;var YI=true; ZI(){OI.disconnect(0);LI.disconnect(0);if(YI){LI.connectNode(OI,0,0);OI.connectNode(JI,0,0);}else{LI.connectNode(JI,0,0);}}mB.PG(this.nH,this.rH,this.JI){LI=nH.DI.createGain();OI=nH.DI.createPanner();OI.coneOuterGain=1.0;ZI();QI=new List<QB>();} set zD( g){if(g!=YI){YI=g;ZI();}} get volume=>LI.gain.value; set volume( g){LI.gain.value=g;} set wD( g){if(g){if(RI!=null){return;}RI=volume;volume=0.0;}else{if(RI==null){return;}volume=RI;RI=null;}} SF( i, h){var g=new QB.PG(this,h,false);QI.add(g);g.play(i);g.pause=pause;return g;} RF( i, h){var g=new QB.PG(this,h,true);QI.add(g);g.play(i);g.pause=pause;return g;} kI(){for(int g=QI.length-1;g>=0;g-- ){var h=QI[g];if(h.KF){var i=QI.length-1;QI[g]=QI[i];QI.removeLast();print('removing sound.');h.stop();}}} get pause=>TI; set pause( g){if(g){if(TI==true){return;}hI();TI=true;}else{if(TI==false){return;}iI();TI=false;}} hI(){kI();QI.forEach((g){g.pause=true;});} iI(){kI();QI.forEach((g){g.pause=false;});} stop(){QI.forEach((g){g.stop();});kI();} get x=>UI; get y=>VI; get z=>XI;}class lE{final  nI;var oI,pI,qI,rI,sI,tI,uI,vI,wI,xI;var yI,zI;lE( this.nI); reset(){var g=this.nI;rI=100/(g.FD*g.FD+.001);sI=100/(g.dC*g.dC+.001);tI=1-g.gC*g.gC*g.gC*.01;uI=-g.YC*g.YC*g.YC*.000001;if(g.HD==0){wI=.5-g.DE/2;xI=-g.mD*.00005;}vI=g.pB>0?1-g.pB*g.pB*.9:1+g.pB*g.pB*10;yI=0;zI=(g.WC==1?0:(1-g.WC)*(1-g.WC)*20000+32).toInt();} ZF(){this.reset();var g=this.nI;oI=g.xB*g.xB*100000;pI=g.gB*g.gB*100000;qI=g.BC*g.BC*100000+10;return (oI+pI+qI).toInt();} YF( u, IB){var g=this.nI;var AJ=g.qB!=1||g.bC!=0,BJ=g.bC*g.bC*.1,CJ=1+g.tD*.0003,DJ=g.qB*g.qB*g.qB*.1,EJ=1+g.uD*.0001,FJ=g.qB!=1,GJ=g.EC*g.EC,HJ=g.dC,IJ=g.FC!=0||g.GC!=0,JJ=g.GC*g.GC*g.GC*.2,KJ=g.FC*g.FC*(g.FC<0?-1020:1020),LJ=(g.eC!=0)?(((1-g.eC)*(1-g.eC)*20000).toInt())+32:0,MJ=g.EE,NJ=g.IE/2,OJ=g.GD*g.GD*.01,PJ=g.HD;var QJ=oI,RJ=1/oI,SJ=1/pI,TJ=1/qI;var UJ=5/(1+g.yC*g.yC*20)*(.01+DJ);if(UJ>.8){UJ=.8;}UJ=1-UJ;var VJ=false;var WJ=0.0,XJ=0.0,YJ=0.0,ZJ=0.0,aJ=0.0,bJ=0.0,cJ=0.0,dJ=0.0,eJ=0.0,fJ=0.0,gJ=0.0;var hJ=0,iJ=0,jJ=0,kJ=0,lJ=0,mJ=0;var o=new JD.Random();var nJ=new List<double>(1024),oJ=new List<double>(32);for(var h=nJ.length-1;h>-1;h-- ){nJ[h]=0.0;}for(var h=oJ.length-1;h>-1;h-- ){oJ[h]=o.nextDouble()*2-1;}for(var h=0;h<IB;h++ ){if(VJ){return true;}if(LJ!=0){if( ++mJ>=LJ){mJ=0;this.reset();}}if(zI!=0){if( ++yI>=zI){zI=0;rI*= vI;}}tI+= uI;rI*= tI;if(rI>sI){rI=sI;if(HJ>0){VJ=true;}}fJ=rI;if(NJ>0){gJ+= OJ;fJ*= 1+JD.sin(gJ)*NJ;}hJ=fJ.toInt();if(hJ<8){hJ=8;}if(PJ==0){wI+= xI;if(wI<0){wI=0.0;}else if(wI>.5){wI=.5;}}if( ++WJ>QJ){WJ=0.0;switch ( ++jJ){case 1:QJ=pI;break;case 2:QJ=qI;break;}}switch (jJ){case 0:XJ=WJ*RJ;break;case 1:XJ=1+(1-WJ*SJ)*2*MJ;break;case 2:XJ=1-WJ*TJ;break;case 3:XJ=0.0;VJ=true;break;}if(IJ){KJ+= JJ;lJ=KJ.toInt();if(lJ<0){lJ=-lJ;}else if(lJ>1023){lJ=1023;}}if(AJ&&CJ!=0.0){BJ*= CJ;if(BJ<.00001){BJ=.00001;}else if(BJ>.1){BJ=.1;}}eJ=0.0;for(var m=0;m<8;m++ ){iJ++ ;if(iJ>=hJ){iJ%= hJ;if(PJ==3){for(var i=oJ.length-1;i>-1;i-- ){oJ[i]=o.nextDouble()*2-1;}}}switch (PJ){case 0:dJ=((iJ/hJ)<wI)?.5:-.5;break;case 1:dJ=1-(iJ/hJ)*2;break;case 2:cJ=iJ/hJ;cJ=cJ>.5?(cJ-1)*6.28318531:cJ*6.28318531;dJ=cJ<0?1.27323954*cJ+.405284735*cJ*cJ:1.27323954*cJ-.405284735*cJ*cJ;dJ=dJ<0?.225*(dJ*-dJ-dJ)+dJ:.225*(dJ*dJ-dJ)+dJ;break;case 3:dJ=oJ[(iJ*32/hJ).abs().toInt()];break;}if(AJ){aJ=bJ;DJ*= EJ;if(DJ<0){DJ=0;}else if(DJ>.1){DJ=.1;}if(FJ){ZJ+= (dJ-bJ)*DJ;ZJ*= UJ;}else{bJ=dJ;ZJ=0.0;}bJ+= ZJ;YJ+= bJ-aJ;YJ*= 1-BJ;dJ=YJ;}if(IJ){nJ[kJ%1024]=dJ;dJ+= nJ[(kJ-lJ+1024)%1024];kJ++ ;}eJ+= dJ;}eJ*= .125*XJ*GJ;eJ=eJ>=1?1.0:eJ<=-1?-1.0:eJ;u[h]=eJ;}return false;}static  mE( m, o){var i=new lE(new cD.QG(o));var h=i.ZF();var g=m.createBuffer(2,h,44100);assert(h<=g.length);i.YF(g.getChannelData(0),h);return g;}}class CB{final  j=new KD.Float32List(2);CB( h, g){CD(h,g);}CB.RG(); CD( h, g){j[0]=h;j[1]=g;return this;} toString()=>'[${j[0]},${j[1]}]'; operator-()=>new CB(-j[0],-j[1]); operator-( g)=>new CB(j[0]-g.j[0],j[1]-g.j[1]); operator+( g)=>new CB(j[0]+g.j[0],j[1]+g.j[1]); operator/( h){var g=1.0/h;return new CB(j[0]*g,j[1]*g);} operator*( h){var g=h;return new CB(j[0]*g,j[1]*g);} operator[]( g)=>j[g]; operator[]=( h, g){j[h]=g;} get length{var g;g=(j[0]*j[0]);g+= (j[1]*j[1]);return JD.sqrt(g);} normalize(){var g=length;if(g==0.0){return this;}g=1.0/g;j[0]*=g;j[1]*=g;return this;} ZC( h){var g;g=j[0]*h.j[0];g+= j[1]*h.j[1];return g;} get isNaN{var g=false;g=g||j[0].isNaN;g=g||j[1].isNaN;return g;} add( g){j[0]=j[0]+g.j[0];j[1]=j[1]+g.j[1];return this;}set x( g)=>j[0]=g;set y( g)=>j[1]=g; get x=>j[0]; get y=>j[1];}class FB{final  j=new KD.Float32List(3);FB( i, h, g){CD(i,h,g);} CD( i, h, g){j[0]=i;j[1]=h;j[2]=g;return this;} toString()=>'[${j[0]},${j[1]},${j[2]}]'; operator-()=>new FB(-j[0],-j[1],-j[2]); operator-( g)=>new FB(j[0]-g.j[0],j[1]-g.j[1],j[2]-g.j[2]); operator+( g)=>new FB(j[0]+g.j[0],j[1]+g.j[1],j[2]+g.j[2]); operator/( h){var g=1.0/h;return new FB(j[0]*g,j[1]*g,j[2]*g);} operator*( h){var g=h;return new FB(j[0]*g,j[1]*g,j[2]*g);} operator[]( g)=>j[g]; operator[]=( h, g){j[h]=g;} get length{var g;g=(j[0]*j[0]);g+= (j[1]*j[1]);g+= (j[2]*j[2]);return JD.sqrt(g);} normalize(){var g=length;if(g==0.0){return this;}g=1.0/g;j[0]*=g;j[1]*=g;j[2]*=g;return this;} ZC( h){var g;g=j[0]*h.j[0];g+= j[1]*h.j[1];g+= j[2]*h.j[2];return g;} get isNaN{var g=false;g=g||j[0].isNaN;g=g||j[1].isNaN;g=g||j[2].isNaN;return g;} add( g){j[0]=j[0]+g.j[0];j[1]=j[1]+g.j[1];j[2]=j[2]+g.j[2];return this;}set x( g)=>j[0]=g;set y( g)=>j[1]=g;set z( g)=>j[2]=g; get x=>j[0]; get y=>j[1]; get z=>j[2];}