import "dart:async" as vB;import "dart:typed_data" as YC;import "dart:json" as RD;import "dart:html" as wB;import "dart:math" as XC;class SD{static const  TD="Chrome";static const  UD="Firefox";static const  VD="Internet Explorer";static const  WD="Safari";final  vC;final  minimumVersion;const SD(this.vC,[this.minimumVersion]);}class XD{const XD();}class YD{final  name;const YD(this.name);}class ZD{const ZD();}class aD{const aD();} main(){wB.window.setImmediate((){var g=wB.query('canvas');g.width=JB;g.height=BB;mC('../assets/img/assets').then((k){var h=new ZC(g,k);h.GD();wB.window.requestAnimationFrame(h.update);});});}class ZC{var canvas;var sheet;var RC=0;var l=new PB();ZC(this.canvas,this.sheet); GD(){hB(l,[new v.pD(JB/2.0,BB-100.0,0.0),new iB('ship_0.png')]);hB(l,[new v.pD(JB/2.0,BB-100.0,0.0),new jB(500.0)]);l.KB(new gD());l.KB(new fD());l.KB(new dD());l.KB(new eD());l.KB(new cD(canvas.context2D,sheet));l.KB(new bD(canvas.context2D,sheet));l.initialize();} update( g){l.LB=g-RC;RC=g;l.process();wB.window.requestAnimationFrame(update);}}class aC{static var yB=0;static var YB;static  cC( h){if(null==YB){YB=new Map<Type,int>();}var g=YB[h];if(g==null){g=1<<yB;yB++ ;YB[h]=g;}return g;}}class eB extends CB{var tD;var xD;eB():tD=new m<m<o>>(),xD=new m<j>(); initialize(){} KE( g){NE(g,(h,k){h[g.id].ME();h[g.id]=null;});g.RE=0;} WE( k, n, AB){var h=n.id;tD.cE(h);var g=tD[h];if(g==null){g=new m<o>();tD[h]=g;}g[k.id]=AB;k.hE(n.cB);} iE( g, h){if((g.RE&h.cB)!=0){var k=h.id;tD[k][g.id].ME();tD[k][g.id]=null;g.kE(h.cB);}} FD( k){var h=k.id;tD.cE(h);var g=tD[h];if(g==null){g=new m<o>();tD[h]=g;}return g;} NE( k, n( components, index)){var g=k.RE;var h=0;while (g>0){if((g&1)==1){n(tD[h],h);}h++ ;g=g>>1;}} TB( g)=>xD.add(g); yC(){xD.forEach((g)=>KE(g));xD.clear();}}class HB{static var fB=1;static var bC=0;var wD=0;var yD=0;HB(){wD=fB;fB=fB<<1;yD=bC++ ;} get cB=>wD; get id=>yD;}class XB{static var zB=new Map<Type,HB>();static  ZB( h){var g=zB[h];if(g==null){g=new HB();zB[h]=g;}return g;}static  eC( g)=>ZB(g).cB;}abstract class xB{ aB( g); mB( g); TB( g); enabled( g); disabled( g);}class dB extends CB{var sD;var uD;var AE;var BE=0;var CE=0;var DE=0;var xD=0;var IE;dB():sD=new m<j>(),uD=new m<j>(),AE=new m<bool>(),IE=new jC(); initialize(){} ZE(){var g=uD.removeLast();if(null==g){g=new j.mD(vD,IE.xC());}DE++ ;return g;} aB( g){BE++ ;CE++ ;sD[g.id]=g;} enabled( g){AE[g.id]=false;} disabled( g){AE[g.id]=true;} TB( g){sD[g.id]=null;AE[g.id]=false;uD.add(g);BE-- ;xD++ ;} isActive( g)=>sD[g]!=null;}abstract class CB implements xB{var vD; initialize(); aB( g){} mB( g){} TB( g){} disabled( g){} enabled( g){}}class NB<u>{var zD;NB.lD(this.zD); operator[]( g)=>zD[g]; get size=>zD.size; get isEmpty=>zD.isEmpty; contains( g)=>zD.contains(g); forEach( g( element))=>zD.forEach(g);}class j{final  id;var PE=0;var RE=0;var YB=0;var vD;var LE;var OE;j.mD(this.vD,this.id){LE=vD.CD;OE=vD.MC;} hE( g){RE|= g;} kE( g){RE&= ~g;} nE( g){YB|= g;} oE( g){YB&= ~g;} toString()=>"Entity[${id}]"; HC( g){OE.WE(this,XB.ZB(g.runtimeType),g);} MD( g){OE.iE(this,XB.ZB(g));} BD()=>vD.AD(this); KC()=>vD.wC(this);}abstract class OB extends IB{OB( g):super(g); MB( g); pB( h)=>h.forEach((g)=>MB(g)); nB()=>true;}class AC extends CB{}class DB<BC extends o>{var GE;var JE;DB( h, g){this.GE=XB.ZB(h);JE=g.MC.FD(this.GE);}BC get( g)=>JE[g.id] as BC;}class m<u>{var EE;var FE=0;var HE;m({ capacity: 16}):EE=new List(capacity){HE=new NB.lD(this);} operator[]( g)=>EE[g]; get size=>FE; get readOnly=>HE; get isEmpty=>FE==0; forEach( h( element)){for(int g=0;g<FE;g++ ){h(EE[g]);}} removeLast(){if(FE>0){var g=EE[ --FE];EE[FE]=null;return g;}return null;} remove( k){for(int g=0;g<FE;g++ ){var h=EE[g];if(k==h){EE[g]=EE[ --FE];EE[FE]=null;return true;}}return false;} contains( h){for(int g=0;FE>g;g++ ){if(h==EE[g]){return true;}}return false;} add( g){if(FE==EE.length){wE();}EE[FE++ ]=g;} operator[]=( g, h){if(g>=EE.length){xE(g*2);}if(FE<=g){FE=g+1;}EE[g]=h;} wE(){var g=((EE.length*3)/2+1).toInt();xE(g);} xE( h){var g=EE;EE=new List<u>(h);EE.setRange(0,g.length,g);} cE( g){if(g>=EE.length){xE(g*2);}} clear(){for(int g=0;g<FE;g++ ){EE[g]=null;}FE=0;} toString()=>"[${EE.join(',')}]";}class CC{static var gB=new Map<Type,m<EB>>();static EB fC( k, n){var h=hC(k);var g=h.removeLast();if(null==g){g=n();}return g;}static  hC( h){var g=gB[h];if(null==g){g=new m();gB[h]=g;}return g;}static  iC( g){gB[g.runtimeType].add(g);}}abstract class o{ ME(){}}abstract class dC extends IB{dC():super(s.kC()); pB( g)=>SC(); SC(); nB()=>true;}class PB{final  LE=new dB();final  OE=new eB();final  CE=new m<j>();final  UE=new m<j>();final  xD=new m<j>();final  bE=new m<j>();final  dE=new m<j>();final  eE=new Map<Type,IB>();final  fE=new List<IB>();final  gE=new Map<Type,CB>();final  jE=new m<CB>();var LB=0;var lE=0;var mE=0.0; get VB=>lE; get time=>mE;PB(){IC(LE);IC(OE);} initialize(){jE.forEach((h)=>h.initialize());fE.forEach((g)=>g.initialize());} get CD=>LE; get MC=>OE; IC( g){gE[g.runtimeType]=g;jE.add(g);g.vD=this;} PC( g){return gE[g];} zC(){return LE.ZE();} KB( g,{ passive: false}){g.l=this;g.aE=passive;eE[g.runtimeType]=g;fE.add(g);return g;} qE( k, h(EntityObserver,Entity)){k.forEach((g){jE.forEach((n)=>h(n,g));fE.forEach((AB)=>h(AB,g));});k.clear();} process(){lE++ ;mE+= LB;LD();fE.forEach((g){if(!g.KD){g.process();}});} LD(){qE(CE,(h,g)=>h.aB(g));qE(UE,(h,g)=>h.mB(g));qE(dE,(h,g)=>h.disabled(g));qE(bE,(h,g)=>h.enabled(g));qE(xD,(h,g)=>h.TB(g));OE.yC();} sC( g)=>CE.add(g); wC( g)=>UE.add(g); AD( g){if(!xD.contains(g)){xD.add(g);}}}class DC extends CB{}abstract class IB implements xB{var QE=0;var l;var SE;var TE;var VE;var XE;var YE;var aE;IB( g):SE=new m<j>(),TE=g.tC,VE=g.ED,XE=g.JD{YE=TE==0&&XE==0;QE=aC.cC(runtimeType);}get KD=>aE; JC(){} process(){if(nB()){JC();pB(SE.readOnly);end();}} end(){} pB( g); nB(); initialize(){} HD( g){} ND( g){} qE( g){if(YE){return;}var k=rE(g);var h=(TE&g.RE)==TE;if(XE>0&&h){h=(XE&g.RE)>0;}if(VE>0&&h){h=(VE&g.RE)==0;}if(h&&!k){uE(g);}else if(!h&&k){vE(g);}} rE( g)=>(QE&g.YB)==QE; uE( g){SE.add(g);g.nE(QE);HD(g);} vE( g){SE.remove(g);g.oE(QE);ND(g);} aB( g)=>qE(g); mB( g)=>qE(g); enabled( g)=>qE(g); TB( g){if(rE(g)){vE(g);}} disabled( g){if(rE(g)){vE(g);}}}class gC extends o with EB{ ME(){ID();} LC(){}}class s{var TE=0;var VE=0;var XE=0; uC( g){TE=pE(TE,g);return this;} DD( g){VE=pE(VE,g);return this;}static  QB( h){var g=new s();g.uC(h);return g;}static  kC()=>new s(); get tC=>TE; get ED=>VE; get JD=>XE; pE( g, h){if(null!=h){h.forEach((k){g=g|XB.eC(k);});}return g;}}typedef  EC();abstract class EB{factory EB.nD( g, h){return CC.fC(g,h);} LC(); ID(){LC();CC.iC(this);}}class jC{var sE;var tE=0;jC():sE=new m<int>(); xC(){if(sE.size>0){return sE.removeLast();}return tE++ ;}}class v extends gC{var WB;var TC;var OD;var yE=new t.rD(); get angle=>TC.z; get position{yE.x=WB.x;yE.y=WB.y;return yE;}set position( g){WB.x=g.x;WB.y=g.y;}v.oD();static lC()=>new v.oD();factory v.pD( k, g, h){return new v.qD(new q(k,g,0.0),new q(0.0,0.0,h));}factory v.qD( n,[ h, k]){var g=new EB.nD(v,lC) as v;g.WB=n;g.TC=(h==null)?new q(0.0,0.0,0.0):h;g.OD=(k==null)?new q(1.0,1.0,1.0):k;return g;}}hB(h, uB,{ player, groups}){var g=h.zC();uB.forEach((k)=>g.HC(k));if(groups!=null){var AB=(h.PC(DC) as DC);groups.forEach((n)=>AB.add(g,n));}if(player!=null){(h.PC(AC) as AC).iD(g,player);}h.sC(g);return g;}class bD extends OB{var GB;var OC;var context;var sheet;bD(this.context,this.sheet):super(s.QB([v,iB])); initialize(){GB=new DB<v>(v,l);OC=new DB<iB>(iB,l);} MB( h){var AB=GB.get(h);var n=OC.get(h);var k=AB.position;var g=sheet.tB[n.UC];context.drawImageToRect(sheet.oB,new wB.Rect(k.x+g.UB.left,k.y+g.UB.top,g.UB.width,g.UB.height),sourceRect:g.src);}} mC( g){return wB.HttpRequest.getString('${g}.json').then(oC).then((h)=>nC(g,h));} nC( uB, PD){var h=new vB.Completer<RB>();var g=new wB.ImageElement();g.onLoad.listen((zE){var k=new Map<String,pC>();PD['frames'].forEach((AB,QD){k[AB]=new pC(QD);});var n=new RB(g,k);h.complete(n);});g.src='${uB}.png';return h.future;} oC( g){return new vB.Future.value(RD.parse(g));}class cD extends dC{var bB;var context;var sheet;cD(this.context,this.sheet); initialize(){bB=new wB.CanvasElement(width:JB,height:BB);var k=bB.context2D;for(int g=0;g<BB/16;g++ ){for(int h=0;h<JB/16;h++ ){k.drawImageToRect(sheet.oB,new wB.Rect(h*16,g*16,16,16),sourceRect:sheet.tB['bg_rect_${GC.nextInt(16)}.png'].src);}}} JC(){context.save();} SC(){context.drawImage(bB,0,(l.time/20)%BB);context.drawImage(bB,0,(l.time/20)%BB-BB+1);} end(){context.restore();}}class RB{final  oB;final  tB;RB(this.oB,this.tB);}class pC{var src;var UB;pC( AB){var g=new qC(AB);var h=g.VB;var k,n;if(g.VC){k=-(g.rB.w~/2-g.sB.x);n=-(g.rB.FB~/2-g.sB.y);}else{k=-g.VB.w~/2;n=-g.VB.FB~/2;}src=new wB.Rect(h.x,h.y,h.w,h.FB);UB=new wB.Rect(k,n,h.w,h.FB);}}class qC{var VB;var VC;var sB;var rB;qC( g):VB=new FC(g["frame"]),VC=g["trimmed"],sB=new FC(g["spriteSourceSize"]),rB=new rC(g["sourceSize"]);}class FC{var x,y,w,FB;FC( g):x=g["x"].toInt(),y=g["y"].toInt(),w=g["w"].toInt(),FB=g["h"].toInt();}class rC{var w,FB;rC( g):w=g["w"].toInt(),FB=g["h"].toInt();}class dD extends OB{var cm;dD():super(s.QB([SB])); initialize(){cm=new DB<SB>(SB,l);} MB( g){var h=cm.get(g);h.value-= l.LB;if(h.value<0.0){g.MD(SB);g.KC();}}}class iB extends o{var UC;iB(this.UC);}class jB extends o{var NC;jB(this.NC);}class SB extends o{var value;SB(this.value);}class kB extends o{var abs,angle;kB(this.abs,this.angle);}class lB extends o{var time;lB(this.time);}const JB=600;const BB=720;class eD extends OB{var em;eD():super(s.QB([lB])); initialize(){em=new DB<lB>(lB,l);} MB( h){var g=em.get(h);g.time-= l.LB;if(g.time<0.0){h.BD();}}}var GC=new XC.Random();class fD extends OB{var QC;var GB;fD():super(s.QB([jB,v]).DD([SB])); initialize(){QC=new DB<jB>(jB,l);GB=new DB<v>(v,l);} MB( g){var h=QC.get(g);g.HC(new SB(h.NC));g.KC();hB(l,[new v.pD(JB/2.0,BB-150.0,0.0),new kB(0.4,0.0),new iB('bullet_${GC.nextInt(4)}.png'),new lB(2000.0)]);}}class gD extends OB{var GB;var WC;gD():super(s.QB([v,kB])); initialize(){GB=new DB<v>(v,l);WC=new DB<kB>(kB,l);} MB( k){var n=GB.get(k);var h=WC.get(k);var g=n.position;g.x=g.x-h.abs*XC.sin(h.angle)*l.LB;g.y=g.y-h.abs*XC.cos(h.angle)*l.LB;n.position=g;}}class t{final  i=new YC.Float32List(2);t( h, g){qB(h,g);}t.rD(); qB( h, g){i[0]=h;i[1]=g;return this;} toString()=>'[${i[0]},${i[1]}]'; operator-()=>new t(-i[0],-i[1]); operator-( g)=>new t(i[0]-g.i[0],i[1]-g.i[1]); operator+( g)=>new t(i[0]+g.i[0],i[1]+g.i[1]); operator/( h){var g=1.0/h;return new t(i[0]*g,i[1]*g);} operator*( h){var g=h;return new t(i[0]*g,i[1]*g);} operator[]( g)=>i[g]; operator[]=( h, g){i[h]=g;} get length{var g;g=(i[0]*i[0]);g+= (i[1]*i[1]);return XC.sqrt(g);} add( g){i[0]=i[0]+g.i[0];i[1]=i[1]+g.i[1];return this;}set x( g)=>i[0]=g;set y( g)=>i[1]=g; get x=>i[0]; get y=>i[1];}class q{final  i=new YC.Float32List(3);q( k, h, g){qB(k,h,g);} qB( k, h, g){i[0]=k;i[1]=h;i[2]=g;return this;} toString()=>'[${i[0]},${i[1]},${i[2]}]'; operator-()=>new q(-i[0],-i[1],-i[2]); operator-( g)=>new q(i[0]-g.i[0],i[1]-g.i[1],i[2]-g.i[2]); operator+( g)=>new q(i[0]+g.i[0],i[1]+g.i[1],i[2]+g.i[2]); operator/( h){var g=1.0/h;return new q(i[0]*g,i[1]*g,i[2]*g);} operator*( h){var g=h;return new q(i[0]*g,i[1]*g,i[2]*g);} operator[]( g)=>i[g]; operator[]=( h, g){i[h]=g;} get length{var g;g=(i[0]*i[0]);g+= (i[1]*i[1]);g+= (i[2]*i[2]);return XC.sqrt(g);} add( g){i[0]=i[0]+g.i[0];i[1]=i[1]+g.i[1];i[2]=i[2]+g.i[2];return this;}set x( g)=>i[0]=g;set y( g)=>i[1]=g; get x=>i[0]; get y=>i[1]; get z=>i[2];}