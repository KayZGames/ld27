import "dart:html" as EC;import "dart:math" as XC;import "dart:typed_data" as vC;import "dart:async" as cB;import "dart:json" as AE;class BE{static const  CE="Chrome";static const  DE="Firefox";static const  EE="Internet Explorer";static const  FE="Safari";final  VD;final  minimumVersion;const BE(this.VD,[this.minimumVersion]);}class GE{const GE();}class HE{final  name;const HE(this.name);}class IE{const IE();}class JE{const JE();} main(){EC.window.setImmediate((){var g=EC.query('canvas');g.width=VB;g.height=JB;cB.Future.wait([MD('../assets/img/assets'),KD('../assets/img/assets')]).then((j){var h=new wC(g,j[0],j[1]);h.lD();EC.window.requestAnimationFrame(h.update);});});}class wC{var canvas;var sheet;var XB;var rC=0;var m=new eB();wC(this.canvas,this.sheet,this.XB); lD(){var g=new cC();m.uB(g);m.uB(new rB());var h=fB(m,[new BB.aE(VB/2.0,JB-100.0,0.0),new hB(0.0,0.0),new UB('ship_0')]);fB(m,[new BB.aE(VB/2.0,JB-165.0,0.0),new hB(0.0,0.0),new JC(500.0)],player:tB);fB(m,[new BB.aE(VB/2.0,0.0,0.0),new hB(0.1,-XC.PI),new UB('truck_0')]);g.register(h,tB);m.KB(new KE(canvas));m.KB(new RE());m.KB(new LE(XB,sheet));m.KB(new QE());m.KB(new OE());m.KB(new PE());m.KB(new NE(canvas.context2D,sheet));m.KB(new ME(canvas.context2D,sheet));m.initialize();} update( g){m.YB=g-rC;rC=g;m.process();EC.window.requestAnimationFrame(update);}}class xC{static  yC( g){var HB=0,q=0,GB=0,v=0,l=0,j=0;var h=g.currentTarget;do{HB+= h.offset.left;q+= h.offset.top;}while(null!=(h=h.offsetParent));if(null!=g.page.x||null!=g.page.y){l=g.page.x;j=g.page.y;}else if(g is EC.MouseEvent){if(null!=g.client.x||null!=g.client.y){l=g.client.x+EC.document.body.scrollLeft+EC.document.documentElement.scrollLeft;j=g.client.y+EC.document.body.scrollTop+EC.document.documentElement.scrollTop;}}GB=l-HB;v=j-q;return new EC.Point(GB,v);}}class FC extends IB{var dE;var fE;var lE;var mE=0;var nE=0;var oE=0;var iE=0;var uE;FC():dE=new o<k>(),fE=new o<k>(),lE=new o<bool>(),uE=new HD(); initialize(){} OF(){var g=fE.removeLast();if(null==g){g=new k.XE(gE,uE.YD());}oE++ ;return g;} vB( g){mE++ ;nE++ ;dE[g.id]=g;} enabled( g){lE[g.id]=false;} disabled( g){lE[g.id]=true;} OB( g){dE[g.id]=null;lE[g.id]=false;fE.add(g);mE-- ;iE++ ;} isActive( g)=>dE[g]!=null; fF( g)=>dE[g];}abstract class YC{ vB( g); MC( g); OB( g); enabled( g); disabled( g);}class GC extends IB{var eE;var iE;GC():eE=new o<o<AB>>(),iE=new o<k>(); initialize(){} xE( g){BF(g,(h,j){h[g.id].AF();h[g.id]=null;});g.GF=0;} LF( j, l, q){var h=l.id;eE.RF(h);var g=eE[h];if(g==null){g=new o<AB>();eE[h]=g;}g[j.id]=q;j.WF(l.xB);} XF( g, h){if((g.GF&h.xB)!=0){var j=h.id;eE[j][g.id].AF();eE[j][g.id]=null;g.ZF(h.xB);}} gD( j){var h=j.id;eE.RF(h);var g=eE[h];if(g==null){g=new o<AB>();eE[h]=g;}return g;} BF( j, l( components, index)){var g=j.GF;var h=0;while (g>0){if((g&1)==1){l(eE[h],h);}h++ ;g=g>>1;}} OB( g)=>iE.add(g); ZD(){iE.forEach((g)=>xE(g));iE.clear();}}class QB{static var HC=1;static var AD=0;var hE=0;var jE=0;QB(){hE=HC;HC=HC<<1;jE=AD++ ;} get xB=>hE; get id=>jE;}class oB{static var aC=new Map<Type,QB>();static  qB( h){var g=aC[h];if(g==null){g=new QB();aC[h]=g;}return g;}static  CD( g)=>qB(g).xB;}class zC{static var ZC=0;static var pB;static  BD( h){if(null==pB){pB=new Map<Type,int>();}var g=pB[h];if(g==null){g=1<<ZC;ZC++ ;pB[h]=g;}return g;}}abstract class IB implements YC{var gE; initialize(); vB( g){} MC( g){} OB( g){} disabled( g){} enabled( g){}}class LB<FB>{var kE;LB.WE(this.kE); operator[]( g)=>kE[g]; get size=>kE.size; get isEmpty=>kE.isEmpty; contains( g)=>kE.contains(g); forEach( g( element))=>kE.forEach(g);}class k{final  id;var EF=0;var GF=0;var pB=0;var gE;var zE;var DF;k.XE(this.gE,this.id){zE=gE.eD;DF=gE.mC;} WF( g){GF|= g;} ZF( g){GF&= ~g;} cF( g){pB|= g;} dF( g){pB&= ~g;} toString()=>"Entity[${id}]"; iC( g){DF.LF(this,oB.qB(g.runtimeType),g);} sD( g){DF.XF(this,oB.qB(g));} cD()=>gE.bD(this); kC()=>gE.XD(this);}abstract class dB extends MB{dB( g):super(g); ZB( g); CC( h)=>h.forEach((g)=>ZB(g)); zB()=>true;}class EB<sB extends AB>{var sE;var vE;EB( h, g){this.sE=oB.qB(h);vE=g.mC.gD(this.sE);}sB get( g)=>vE[g.id] as sB; jD( g){if(vE.nD(g.id)){return vE[g.id] as sB;}return null;}}class rB extends IB{var rE;var wE;rB(){rE=new Map<k,String>();wE=new Map<String,o<k>>();} wD( j, h){rE[j]=h;var g=wE[h];if(g==null){g=new o<k>();wE[h]=g;}g.add(j);} hD( h){var g=wE[h];if(g==null){g=new o<k>();}return g.readOnly;} tD( g){var h=rE[g];if(h!=null){var j=wE[h];if(j!=null){j.remove(g);}}} initialize(){} OB( g)=>tD(g);}class o<FB>{var pE;var qE=0;var tE;o({ capacity: 16}):pE=new List(capacity){tE=new LB.WE(this);} operator[]( g)=>pE[g]; get size=>qE; get readOnly=>tE; get isEmpty=>qE==0; forEach( h( element)){for(int g=0;g<qE;g++ ){h(pE[g]);}} removeLast(){if(qE>0){var g=pE[ --qE];pE[qE]=null;return g;}return null;} remove( j){for(int g=0;g<qE;g++ ){var h=pE[g];if(j==h){pE[g]=pE[ --qE];pE[qE]=null;return true;}}return false;} contains( h){for(int g=0;qE>g;g++ ){if(h==pE[g]){return true;}}return false;} get WD=>pE.length; add( g){if(qE==pE.length){mF();}pE[qE++ ]=g;} operator[]=( g, h){if(g>=pE.length){nF(g*2);}if(qE<=g){qE=g+1;}pE[g]=h;} mF(){var g=((pE.length*3)/2+1).toInt();nF(g);} nF( h){var g=pE;pE=new List<FB>(h);pE.setRange(0,g.length,g);} RF( g){if(g>=pE.length){nF(g*2);}} clear(){for(int g=0;g<qE;g++ ){pE[g]=null;}qE=0;} nD( g)=>g<WD; toString()=>"[${pE.join(',')}]";}class bC{static var IC=new Map<Type,o<NB>>();static NB DD( j, l){var h=FD(j);var g=h.removeLast();if(null==g){g=l();}return g;}static  FD( h){var g=IC[h];if(null==g){g=new o();IC[h]=g;}return g;}static  GD( g){IC[g.runtimeType].add(g);}}abstract class AB{ AF(){}}class cC extends IB{final  yE;final  CF;cC():yE=new Map<String,k>(),CF=new Map<k,String>(); register( g, h){yE[h]=g;CF[g]=h;} unregister( g){CF.remove(yE.remove(g));} pC( g)=>yE[g]; OB( h){var g=CF.remove(h);if(g!=null){yE.remove(g);}} initialize(){}}abstract class dC extends MB{dC():super(DB.ID()); CC( g)=>PC(); PC(); zB()=>true;}class eB{final  zE=new FC();final  DF=new GC();final  nE=new o<k>();final  JF=new o<k>();final  iE=new o<k>();final  QF=new o<k>();final  SF=new o<k>();final  TF=new Map<Type,MB>();final  UF=new List<MB>();final  VF=new Map<Type,IB>();final  YF=new o<IB>();var YB=0;var aF=0;var bF=0.0; get jB=>aF; get time=>bF;eB(){uB(zE);uB(DF);} initialize(){YF.forEach((h)=>h.initialize());UF.forEach((g)=>g.initialize());} get eD=>zE; get mC=>DF; uB( g){VF[g.runtimeType]=g;YF.add(g);g.gE=this;} BC( g){return VF[g];} aD(){return zE.OF();} pC( g){return zE.fF(g);} KB( g,{ passive: false}){g.m=this;g.PF=passive;TF[g.runtimeType]=g;UF.add(g);return g;} gF( j, h(EntityObserver,Entity)){j.forEach((g){YF.forEach((l)=>h(l,g));UF.forEach((q)=>h(q,g));});j.clear();} process(){aF++ ;bF+= YB;rD();UF.forEach((g){if(!g.qD){g.process();}});} rD(){gF(nE,(h,g)=>h.vB(g));gF(JF,(h,g)=>h.MC(g));gF(SF,(h,g)=>h.disabled(g));gF(QF,(h,g)=>h.enabled(g));gF(iE,(h,g)=>h.OB(g));DF.ZD();} SD( g)=>nE.add(g); XD( g)=>JF.add(g); bD( g){if(!iE.contains(g)){iE.add(g);}}}class eC extends IB{}abstract class MB implements YC{var FF=0;var m;var HF;var IF;var KF;var MF;var NF;var PF;MB( g):HF=new o<k>(),IF=g.TD,KF=g.fD,MF=g.pD{NF=IF==0&&MF==0;FF=zC.BD(runtimeType);}get qD=>PF; jC(){} process(){if(zB()){jC();CC(HF.readOnly);end();}} end(){} CC( g); zB(); initialize(){} mD( g){} uD( g){} gF( g){if(NF){return;}var j=hF(g);var h=(IF&g.GF)==IF;if(MF>0&&h){h=(MF&g.GF)>0;}if(KF>0&&h){h=(KF&g.GF)==0;}if(h&&!j){kF(g);}else if(!h&&j){lF(g);}} hF( g)=>(FF&g.pB)==FF; kF( g){HF.add(g);g.cF(FF);mD(g);} lF( g){HF.remove(g);g.dF(FF);uD(g);} vB( g)=>gF(g); MC( g)=>gF(g); enabled( g)=>gF(g); OB( g){if(hF(g)){lF(g);}} disabled( g){if(hF(g)){lF(g);}}}class ED extends AB with NB{ AF(){oD();} lC(){}}class DB{var IF=0;var KF=0;var MF=0; UD( g){IF=eF(IF,g);return this;} oC( g){KF=eF(KF,g);return this;}static  RB( h){var g=new DB();g.UD(h);return g;}static  ID()=>new DB(); get TD=>IF; get fD=>KF; get pD=>MF; eF( g, h){if(null!=h){h.forEach((j){g=g|oB.CD(j);});}return g;}}typedef  fC();abstract class NB{factory NB.YE( g, h){return bC.DD(g,h);} lC(); oD(){lC();bC.GD(this);}}class HD{var iF;var jF=0;HD():iF=new o<int>(); YD(){if(iF.size>0){return iF.removeLast();}return jF++ ;}}class BB extends ED{var kB;var QC;var vD;var oF=new t.cE(); get angle=>QC.z;set angle( g)=>QC.z=g; get position{oF.x=kB.x;oF.y=kB.y;return oF;}set position( g){kB.x=g.x;kB.y=g.y;}BB.ZE();static JD()=>new BB.ZE();factory BB.aE( j, g, h){return new BB.bE(new u(j,g,0.0),new u(0.0,0.0,h));}factory BB.bE( l,[ h, j]){var g=new NB.YE(BB,JD) as BB;g.kB=l;g.QC=(h==null)?new u(0.0,0.0,0.0):h;g.vD=(j==null)?new u(1.0,1.0,1.0):j;return g;}}fB(h, v,{ player, groups}){var g=h.aD();v.forEach((j)=>g.iC(j));if(groups!=null){var q=(h.BC(eC) as eC);groups.forEach((l)=>q.add(g,l));}if(player!=null){(h.BC(rB) as rB).wD(g,player);}h.SD(g);return g;}class LE extends MB{var CB;var WB;var XB;var sheet;LE(this.XB,this.sheet):super(DB.RB([BB,UB]).oC([RD])); initialize(){CB=new EB<BB>(BB,m);WB=new EB<UB>(UB,m);} CC( g){var DC=g.size;if(DC>1){for(int h=0;h<g.size-1;h++ ){for(int l=h+1;l<g.size;l++ ){var q=g[h];var GB=g[l];var j=CB.get(q).position;var UC=CB.get(GB).position;var HB=WB.get(q).yB;var v=WB.get(GB).yB;var mB=XB[HB];var nB=XB[v];var VC=sheet.lB['${HB}.png'].offset;var WC=sheet.lB['${v}.png'].offset;if(dD(mB,j+VC,nB,UC+WC)){fB(m,[new BB.aE(j.x,j.y,0.0),new hB(0.0,0.0),new UB('impact_${LC.nextInt(8)}'),new RD(),new KC(100.0)]);}}}}} dD( UC, v, WC, VC){var g=true;WC.forEach((xD){g=false;UC.where((pF)=>!g).forEach((nB){g=true;var DC=nB.aB.last;nB.aB.forEach((mB){var HB=iD(DC+v,mB+v);var l=(mB+v).AC(HB);var GB=l;nB.aB.sublist(1).forEach((yD){var h=(yD+v).AC(HB);l=XC.min(l,h);GB=XC.max(GB,h);});var j;var q;var VE=true;xD.aB.forEach((zD){var h=(zD+VC).AC(HB);if(null==j){j=h;q=h;}j=XC.min(j,h);q=XC.max(q,h);});if(GB<j||l>q){g=false;return;}DC=mB;});if(g){return;}});if(g){return;}});return g;} iD( h, j){var g=new t(-h.y+j.y,h.x-j.x);g.normalize();return g;} zB()=>true;}class KE extends dC{var canvas;var OC;var sC;var tC;var bB;var CB;KE(this.canvas); initialize(){sC=m.BC(rB);tC=m.BC(cC);bB=new EB<hB>(hB,m);CB=new EB<BB>(BB,m);canvas.onMouseMove.listen(kD);} PC(){if(null!=OC){var l=tC.pC(tB);var g=bB.get(l);var v=CB.get(l).position;var j=v.x-OC.x;if(j>5){g.angle=XC.PI/2;g.abs=0.25;}else if(j<-5){g.angle=-XC.PI/2;g.abs=0.25;}else{g.angle=0.0;g.abs=0.0;}sC.hD(tB).forEach((q){var h=bB.jD(q);if(null!=h){h.abs=g.abs;h.angle=g.angle;}});}} kD( g){OC=xC.yC(g);}}class ME extends dB{var CB;var WB;var context;var sheet;ME(this.context,this.sheet):super(DB.RB([BB,UB])); initialize(){CB=new EB<BB>(BB,m);WB=new EB<UB>(UB,m);} ZB( h){var q=CB.get(h);var l=WB.get(h);var j=q.position;var g=sheet.lB['${l.yB}.png'];context.drawImageToRect(sheet.NC,new EC.Rect(j.x+g.iB.left,j.y+g.iB.top,g.iB.width,g.iB.height),sourceRect:g.src);}} KD( g){return EC.HttpRequest.getString('${g}.polygons.json').then(hC).then(LD);} LD( v){var g=new Map<String,List<TB>>();v.forEach((l,q){var h=new List<TB>();q.forEach((j)=>h.add(new TB(j['shape'])));g[l]=h;});return new cB.Future.value(g);} MD( g){return EC.HttpRequest.getString('${g}.json').then(hC).then((h)=>ND(g,h));} ND( v, HB){var h=new cB.Completer<SB>();var g=new EC.ImageElement();g.onLoad.listen((pF){var j=new Map<String,OD>();HB['frames'].forEach((q,GB){j[q]=new OD(GB);});var l=new SB(g,j);h.complete(l);});g.src='${v}.png';return h.future;}class SB{final  NC;final  lB;SB(this.NC,this.lB);}class OD{var src;var iB;var offset;OD( q){var g=new PD(q);var h=g.jB;var j,l;if(g.uC){j=-(g.SC.w~/2-g.TC.x);l=-(g.SC.PB~/2-g.TC.y);}else{j=-g.jB.w~/2;l=-g.jB.PB~/2;}src=new EC.Rect(h.x,h.y,h.w,h.PB);iB=new EC.Rect(j,l,h.w,h.PB);offset=new t(j.toDouble(),l.toDouble());}}class NE extends dC{var wB;var context;var sheet;NE(this.context,this.sheet); initialize(){wB=new EC.CanvasElement(width:VB,height:JB);var j=wB.context2D;for(int g=0;g<JB/16;g++ ){for(int h=0;h<VB/16;h++ ){j.drawImageToRect(sheet.NC,new EC.Rect(h*16,g*16,16,16),sourceRect:sheet.lB['bg_rect_${LC.nextInt(16)}.png'].src);}}} jC(){context.save();} PC(){context.drawImage(wB,0,(m.time/20)%JB);context.drawImage(wB,0,(m.time/20)%JB-JB+1);} end(){context.restore();}}class PD{var jB;var uC;var TC;var SC;PD( g):jB=new gC(g["frame"]),uC=g["trimmed"],TC=new gC(g["spriteSourceSize"]),SC=new QD(g["sourceSize"]);}class gC{var x,y,w,PB;gC( g):x=g["x"].toInt(),y=g["y"].toInt(),w=g["w"].toInt(),PB=g["h"].toInt();}class QD{var w,PB;QD( g):w=g["w"].toInt(),PB=g["h"].toInt();} hC( g){return new cB.Future.value(AE.parse(g));}class OE extends dB{var cm;OE():super(DB.RB([gB])); initialize(){cm=new EB<gB>(gB,m);} ZB( g){var h=cm.get(g);h.value-= m.YB;if(h.value<0.0){g.sD(gB);g.kC();}}}class JC extends AB{var nC;JC(this.nC);}class TB{var aB;TB( h){aB=new List(h.length~/2);for(int g=0;g<h.length;g+= 2){aB[g~/2]=new t(h[g].toDouble(),h[g+1].toDouble());}}}class gB extends AB{var value;gB(this.value);}class hB extends AB{var abs,angle;hB(this.abs,this.angle);}class KC extends AB{var time;KC(this.time);}class UB extends AB{var yB;UB(this.yB);}class RD extends AB{}class PE extends dB{var em;PE():super(DB.RB([KC])); initialize(){em=new EB<KC>(KC,m);} ZB( h){var g=em.get(h);g.time-= m.YB;if(g.time<0.0){h.cD();}}}const VB=600;const JB=720;const tB='player1';var LC=new XC.Random();class QE extends dB{var qC;var CB;QE():super(DB.RB([JC,BB]).oC([gB])); initialize(){qC=new EB<JC>(JC,m);CB=new EB<BB>(BB,m);} ZB( g){var j=qC.get(g);var h=CB.get(g).position;g.iC(new gB(j.nC));g.kC();fB(m,[new BB.aE(h.x,h.y,0.0),new hB(0.4,0.0),new UB('bullet_${LC.nextInt(4)}'),new KC(2000.0)]);}}class RE extends dB{var CB;var bB;RE():super(DB.RB([BB,hB])); initialize(){CB=new EB<BB>(BB,m);bB=new EB<hB>(hB,m);} ZB( j){var l=CB.get(j);var h=bB.get(j);var g=l.position;g.x=g.x-h.abs*XC.sin(h.angle)*m.YB;g.y=g.y-h.abs*XC.cos(h.angle)*m.YB;l.position=g;}}class t{final  i=new vC.Float32List(2);t( h, g){RC(h,g);}t.cE(); RC( h, g){i[0]=h;i[1]=g;return this;} toString()=>'[${i[0]},${i[1]}]'; operator-()=>new t(-i[0],-i[1]); operator-( g)=>new t(i[0]-g.i[0],i[1]-g.i[1]); operator+( g)=>new t(i[0]+g.i[0],i[1]+g.i[1]); operator/( h){var g=1.0/h;return new t(i[0]*g,i[1]*g);} operator*( h){var g=h;return new t(i[0]*g,i[1]*g);} operator[]( g)=>i[g]; operator[]=( h, g){i[h]=g;} get length{var g;g=(i[0]*i[0]);g+= (i[1]*i[1]);return XC.sqrt(g);} normalize(){var g=length;if(g==0.0){return this;}g=1.0/g;i[0]*=g;i[1]*=g;return this;} AC( h){var g;g=i[0]*h.i[0];g+= i[1]*h.i[1];return g;} get isNaN{var g=false;g=g||i[0].isNaN;g=g||i[1].isNaN;return g;} add( g){i[0]=i[0]+g.i[0];i[1]=i[1]+g.i[1];return this;}set x( g)=>i[0]=g;set y( g)=>i[1]=g; get x=>i[0]; get y=>i[1];}class u{final  i=new vC.Float32List(3);u( j, h, g){RC(j,h,g);} RC( j, h, g){i[0]=j;i[1]=h;i[2]=g;return this;} toString()=>'[${i[0]},${i[1]},${i[2]}]'; operator-()=>new u(-i[0],-i[1],-i[2]); operator-( g)=>new u(i[0]-g.i[0],i[1]-g.i[1],i[2]-g.i[2]); operator+( g)=>new u(i[0]+g.i[0],i[1]+g.i[1],i[2]+g.i[2]); operator/( h){var g=1.0/h;return new u(i[0]*g,i[1]*g,i[2]*g);} operator*( h){var g=h;return new u(i[0]*g,i[1]*g,i[2]*g);} operator[]( g)=>i[g]; operator[]=( h, g){i[h]=g;} get length{var g;g=(i[0]*i[0]);g+= (i[1]*i[1]);g+= (i[2]*i[2]);return XC.sqrt(g);} normalize(){var g=length;if(g==0.0){return this;}g=1.0/g;i[0]*=g;i[1]*=g;i[2]*=g;return this;} AC( h){var g;g=i[0]*h.i[0];g+= i[1]*h.i[1];g+= i[2]*h.i[2];return g;} get isNaN{var g=false;g=g||i[0].isNaN;g=g||i[1].isNaN;g=g||i[2].isNaN;return g;} add( g){i[0]=i[0]+g.i[0];i[1]=i[1]+g.i[1];i[2]=i[2]+g.i[2];return this;}set x( g)=>i[0]=g;set y( g)=>i[1]=g;set z( g)=>i[2]=g; get x=>i[0]; get y=>i[1]; get z=>i[2];}