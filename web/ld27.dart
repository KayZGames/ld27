import "dart:async" as TB;import "dart:json" as nD;import "dart:html" as rB;import "dart:math" as LC;import "dart:typed_data" as mC;class oD{static const  pD="Chrome";static const  qD="Firefox";static const  rD="Internet Explorer";static const  sD="Safari";final  MD;final  minimumVersion;const oD(this.MD,[this.minimumVersion]);}class tD{const tD();}class uD{final  name;const uD(this.name);}class vD{const vD();}class wD{const wD();} main(){rB.window.setImmediate((){var g=rB.query('canvas');g.width=PB;g.height=HB;TB.Future.wait([DD('../assets/img/assets'),BD('../assets/img/assets')]).then((k){var h=new nC(g,k[0],k[1]);h.bD();rB.window.requestAnimationFrame(h.update);});});}class nC{var canvas;var sheet;var LD;var hC=0;var l=new VB();nC(this.canvas,this.sheet,this.LD); bD(){var g=new QC();l.kB(g);l.kB(new gB());var h=iB(l,[new AB.LE(PB/2.0,HB-100.0,0.0),new ZB(0.0,0.0),new zB('ship_0')]);iB(l,[new AB.LE(PB/2.0,HB-150.0,0.0),new ZB(0.0,0.0),new xB(500.0)],player:jB);iB(l,[new AB.LE(PB/2.0,0.0,0.0),new ZB(0.1,-LC.PI),new zB('truck_0')]);g.register(h,jB);l.JB(new xD(canvas));l.JB(new DE());l.JB(new CE());l.JB(new AE());l.JB(new BE());l.JB(new zD(canvas.context2D,sheet));l.JB(new yD(canvas.context2D,sheet));l.initialize();} update( g){l.QB=g-hC;hC=g;l.process();rB.window.requestAnimationFrame(update);}}class oC{static  pC( g){var pB=0,q=0,qB=0,FB=0,m=0,k=0;var h=g.currentTarget;do{pB+= h.offset.left;q+= h.offset.top;}while(null!=(h=h.offsetParent));if(null!=g.page.x||null!=g.page.y){m=g.page.x;k=g.page.y;}else if(g is rB.MouseEvent){if(null!=g.client.x||null!=g.client.y){m=g.client.x+rB.document.body.scrollLeft+rB.document.documentElement.scrollLeft;k=g.client.y+rB.document.body.scrollTop+rB.document.documentElement.scrollTop;}}qB=m-pB;FB=k-q;return new rB.Point(qB,FB);}}class dB{static var OC=new Map<Type,MB>();static  fB( h){var g=OC[h];if(g==null){g=new MB();OC[h]=g;}return g;}static  tC( g)=>fB(g).nB;}class qC{static var NC=0;static var eB;static  sC( h){if(null==eB){eB=new Map<Type,int>();}var g=eB[h];if(g==null){g=1<<NC;NC++ ;eB[h]=g;}return g;}}class sB extends GB{var PE;var TE;sB():PE=new o<o<t>>(),TE=new o<j>(); initialize(){} iE( g){mE(g,(h,k){h[g.id].lE();h[g.id]=null;});g.rE=0;} wE( k, m, q){var h=m.id;PE.CF(h);var g=PE[h];if(g==null){g=new o<t>();PE[h]=g;}g[k.id]=q;k.HF(m.nB);} IF( g, h){if((g.rE&h.nB)!=0){var k=h.id;PE[k][g.id].lE();PE[k][g.id]=null;g.KF(h.nB);}} XD( k){var h=k.id;PE.CF(h);var g=PE[h];if(g==null){g=new o<t>();PE[h]=g;}return g;} mE( k, m( components, index)){var g=k.rE;var h=0;while (g>0){if((g&1)==1){m(PE[h],h);}h++ ;g=g>>1;}} KB( g)=>TE.add(g); QD(){TE.forEach((g)=>iE(g));TE.clear();}}class MB{static var uB=1;static var rC=0;var SE=0;var UE=0;MB(){SE=uB;uB=uB<<1;UE=rC++ ;} get nB=>SE; get id=>UE;}abstract class MC{ lB( g); AC( g); KB( g); enabled( g); disabled( g);}class tB extends GB{var OE;var QE;var WE;var XE=0;var YE=0;var ZE=0;var TE=0;var fE;tB():OE=new o<j>(),QE=new o<j>(),WE=new o<bool>(),fE=new yC(); initialize(){} zE(){var g=QE.removeLast();if(null==g){g=new j.IE(RE,fE.PD());}ZE++ ;return g;} lB( g){XE++ ;YE++ ;OE[g.id]=g;} enabled( g){WE[g.id]=false;} disabled( g){WE[g.id]=true;} KB( g){OE[g.id]=null;WE[g.id]=false;QE.add(g);XE-- ;TE++ ;} isActive( g)=>OE[g]!=null; QF( g)=>OE[g];}abstract class GB implements MC{var RE; initialize(); lB( g){} AC( g){} KB( g){} disabled( g){} enabled( g){}}class NB<CB>{var VE;NB.HE(this.VE); operator[]( g)=>VE[g]; get size=>VE.size; get isEmpty=>VE.isEmpty; contains( g)=>VE.contains(g); forEach( g( element))=>VE.forEach(g);}class j{final  id;var pE=0;var rE=0;var eB=0;var RE;var kE;var oE;j.IE(this.RE,this.id){kE=RE.UD;oE=RE.dC;} HF( g){rE|= g;} KF( g){rE&= ~g;} NF( g){eB|= g;} OF( g){eB&= ~g;} toString()=>"Entity[${id}]"; XC( g){oE.wE(this,dB.fB(g.runtimeType),g);} iD( g){oE.IF(this,dB.fB(g));} TD()=>RE.SD(this); bC()=>RE.OD(this);}abstract class UB extends OB{UB( g):super(g); RB( g); EC( h)=>h.forEach((g)=>RB(g)); BC()=>true;}class EB<hB extends t>{var dE;var gE;EB( h, g){this.dE=dB.fB(h);gE=g.dC.XD(this.dE);}hB get( g)=>gE[g.id] as hB; ZD( g){if(gE.dD(g.id)){return gE[g.id] as hB;}return null;}}class gB extends GB{var cE;var hE;gB(){cE=new Map<j,String>();hE=new Map<String,o<j>>();} mD( k, h){cE[k]=h;var g=hE[h];if(g==null){g=new o<j>();hE[h]=g;}g.add(k);} YD( h){var g=hE[h];if(g==null){g=new o<j>();}return g.readOnly;} jD( g){var h=cE[g];if(h!=null){var k=hE[h];if(k!=null){k.remove(g);}}} initialize(){} KB( g)=>jD(g);}class o<CB>{var aE;var bE=0;var eE;o({ capacity: 16}):aE=new List(capacity){eE=new NB.HE(this);} operator[]( g)=>aE[g]; get size=>bE; get readOnly=>eE; get isEmpty=>bE==0; forEach( h( element)){for(int g=0;g<bE;g++ ){h(aE[g]);}} removeLast(){if(bE>0){var g=aE[ --bE];aE[bE]=null;return g;}return null;} remove( k){for(int g=0;g<bE;g++ ){var h=aE[g];if(k==h){aE[g]=aE[ --bE];aE[bE]=null;return true;}}return false;} contains( h){for(int g=0;bE>g;g++ ){if(h==aE[g]){return true;}}return false;} get ND=>aE.length; add( g){if(bE==aE.length){XF();}aE[bE++ ]=g;} operator[]=( g, h){if(g>=aE.length){YF(g*2);}if(bE<=g){bE=g+1;}aE[g]=h;} XF(){var g=((aE.length*3)/2+1).toInt();YF(g);} YF( h){var g=aE;aE=new List<CB>(h);aE.setRange(0,g.length,g);} CF( g){if(g>=aE.length){YF(g*2);}} clear(){for(int g=0;g<bE;g++ ){aE[g]=null;}bE=0;} dD( g)=>g<ND; toString()=>"[${aE.join(',')}]";}class PC{static var vB=new Map<Type,o<IB>>();static IB uC( k, m){var h=wC(k);var g=h.removeLast();if(null==g){g=m();}return g;}static  wC( h){var g=vB[h];if(null==g){g=new o();vB[h]=g;}return g;}static  xC( g){vB[g.runtimeType].add(g);}}abstract class t{ lE(){}}class QC extends GB{final  jE;final  nE;QC():jE=new Map<String,j>(),nE=new Map<j,String>(); register( g, h){jE[h]=g;nE[g]=h;} unregister( g){nE.remove(jE.remove(g));} fC( g)=>jE[g]; KB( h){var g=nE.remove(h);if(g!=null){jE.remove(g);}} initialize(){}}abstract class RC extends OB{RC():super(v.zC()); EC( g)=>FC(); FC(); BC()=>true;}class VB{final  kE=new tB();final  oE=new sB();final  YE=new o<j>();final  uE=new o<j>();final  TE=new o<j>();final  BF=new o<j>();final  DF=new o<j>();final  EF=new Map<Type,OB>();final  FF=new List<OB>();final  GF=new Map<Type,GB>();final  JF=new o<GB>();var QB=0;var LF=0;var MF=0.0; get bB=>LF; get time=>MF;VB(){kB(kE);kB(oE);} initialize(){JF.forEach((h)=>h.initialize());FF.forEach((g)=>g.initialize());} get UD=>kE; get dC=>oE; kB( g){GF[g.runtimeType]=g;JF.add(g);g.RE=this;} oB( g){return GF[g];} RD(){return kE.zE();} fC( g){return kE.QF(g);} JB( g,{ passive: false}){g.l=this;g.AF=passive;EF[g.runtimeType]=g;FF.add(g);return g;} RF( k, h(EntityObserver,Entity)){k.forEach((g){JF.forEach((m)=>h(m,g));FF.forEach((q)=>h(q,g));});k.clear();} process(){LF++ ;MF+= QB;hD();FF.forEach((g){if(!g.gD){g.process();}});} hD(){RF(YE,(h,g)=>h.lB(g));RF(uE,(h,g)=>h.AC(g));RF(DF,(h,g)=>h.disabled(g));RF(BF,(h,g)=>h.enabled(g));RF(TE,(h,g)=>h.KB(g));oE.QD();} ID( g)=>YE.add(g); OD( g)=>uE.add(g); SD( g){if(!TE.contains(g)){TE.add(g);}}}class SC extends GB{}abstract class OB implements MC{var qE=0;var l;var sE;var tE;var vE;var xE;var yE;var AF;OB( g):sE=new o<j>(),tE=g.JD,vE=g.WD,xE=g.fD{yE=tE==0&&xE==0;qE=qC.sC(runtimeType);}get gD=>AF; YC(){} process(){if(BC()){YC();EC(sE.readOnly);end();}} end(){} EC( g); BC(); initialize(){} cD( g){} kD( g){} RF( g){if(yE){return;}var k=SF(g);var h=(tE&g.rE)==tE;if(xE>0&&h){h=(xE&g.rE)>0;}if(vE>0&&h){h=(vE&g.rE)==0;}if(h&&!k){VF(g);}else if(!h&&k){WF(g);}} SF( g)=>(qE&g.eB)==qE; VF( g){sE.add(g);g.NF(qE);cD(g);} WF( g){sE.remove(g);g.OF(qE);kD(g);} lB( g)=>RF(g); AC( g)=>RF(g); enabled( g)=>RF(g); KB( g){if(SF(g)){WF(g);}} disabled( g){if(SF(g)){WF(g);}}}class vC extends t with IB{ lE(){eD();} cC(){}}class v{var tE=0;var vE=0;var xE=0; KD( g){tE=PF(tE,g);return this;} VD( g){vE=PF(vE,g);return this;}static  WB( h){var g=new v();g.KD(h);return g;}static  zC()=>new v(); get JD=>tE; get WD=>vE; get fD=>xE; PF( g, h){if(null!=h){h.forEach((k){g=g|dB.tC(k);});}return g;}}typedef  TC();abstract class IB{factory IB.JE( g, h){return PC.uC(g,h);} cC(); eD(){cC();PC.xC(this);}}class yC{var TF;var UF=0;yC():TF=new o<int>(); PD(){if(TF.size>0){return TF.removeLast();}return UF++ ;}}class AB extends vC{var cB;var GC;var lD;var ZF=new BB.NE(); get angle=>GC.z;set angle( g)=>GC.z=g; get position{ZF.x=cB.x;ZF.y=cB.y;return ZF;}set position( g){cB.x=g.x;cB.y=g.y;}AB.KE();static AD()=>new AB.KE();factory AB.LE( k, g, h){return new AB.ME(new u(k,g,0.0),new u(0.0,0.0,h));}factory AB.ME( m,[ h, k]){var g=new IB.JE(AB,AD) as AB;g.cB=m;g.GC=(h==null)?new u(0.0,0.0,0.0):h;g.lD=(k==null)?new u(1.0,1.0,1.0):k;return g;}}iB(h, FB,{ player, groups}){var g=h.RD();FB.forEach((k)=>g.XC(k));if(groups!=null){var q=(h.oB(SC) as SC);groups.forEach((m)=>q.add(g,m));}if(player!=null){(h.oB(gB) as gB).mD(g,player);}h.ID(g);return g;}class yD extends UB{var DB;var ZC;var context;var sheet;yD(this.context,this.sheet):super(v.WB([AB,zB])); initialize(){DB=new EB<AB>(AB,l);ZC=new EB<zB>(zB,l);} RB( h){var q=DB.get(h);var m=ZC.get(h);var k=q.position;var g=sheet.KC['${m.aC}.png'];context.drawImageToRect(sheet.CC,new rB.Rect(k.x+g.aB.left,k.y+g.aB.top,g.aB.width,g.aB.height),sourceRect:g.src);}}class xD extends RC{var canvas;var DC;var iC;var jC;var SB;var DB;xD(this.canvas); initialize(){iC=l.oB(gB);jC=l.oB(QC);SB=new EB<ZB>(ZB,l);DB=new EB<AB>(AB,l);canvas.onMouseMove.listen(aD);} FC(){if(null!=DC){var m=jC.fC(jB);var g=SB.get(m);var FB=DB.get(m).position;var k=FB.x-DC.x;if(k>5){g.angle=LC.PI/2;g.abs=0.25;}else if(k<-5){g.angle=-LC.PI/2;g.abs=0.25;}else{g.angle=0.0;g.abs=0.0;}iC.YD(jB).forEach((q){var h=SB.ZD(q);if(null!=h){h.abs=g.abs;h.angle=g.angle;}});}} aD( g){DC=oC.pC(g);}} BD( g){return rB.HttpRequest.getString('${g}.polygons.json').then(VC).then(CD);} CD( FB){var g=new Map<String,List<wB>>();FB.forEach((m,q){var h=new List<wB>();q.forEach((k)=>h.add(new wB(k['shape'])));g[m]=h;});return new TB.Future.value(g);}class wB{var lC;wB( h){lC=new List(h.length~/2);for(int g=0;g<h.length;g+= 2){lC[g~/2]=new rB.Point(h[g],h[g+1]);}}} DD( g){return rB.HttpRequest.getString('${g}.json').then(VC).then((h)=>ED(g,h));} ED( FB, pB){var h=new TB.Completer<XB>();var g=new rB.ImageElement();g.onLoad.listen((aF){var k=new Map<String,FD>();pB['frames'].forEach((q,qB){k[q]=new FD(qB);});var m=new XB(g,k);h.complete(m);});g.src='${FB}.png';return h.future;}class XB{final  CC;final  KC;XB(this.CC,this.KC);}class FD{var src;var aB;FD( q){var g=new GD(q);var h=g.bB;var k,m;if(g.kC){k=-(g.IC.w~/2-g.JC.x);m=-(g.IC.LB~/2-g.JC.y);}else{k=-g.bB.w~/2;m=-g.bB.LB~/2;}src=new rB.Rect(h.x,h.y,h.w,h.LB);aB=new rB.Rect(k,m,h.w,h.LB);}}class zD extends RC{var mB;var context;var sheet;zD(this.context,this.sheet); initialize(){mB=new rB.CanvasElement(width:PB,height:HB);var k=mB.context2D;for(int g=0;g<HB/16;g++ ){for(int h=0;h<PB/16;h++ ){k.drawImageToRect(sheet.CC,new rB.Rect(h*16,g*16,16,16),sourceRect:sheet.KC['bg_rect_${WC.nextInt(16)}.png'].src);}}} YC(){context.save();} FC(){context.drawImage(mB,0,(l.time/20)%HB);context.drawImage(mB,0,(l.time/20)%HB-HB+1);} end(){context.restore();}}class GD{var bB;var kC;var JC;var IC;GD( g):bB=new UC(g["frame"]),kC=g["trimmed"],JC=new UC(g["spriteSourceSize"]),IC=new HD(g["sourceSize"]);}class UC{var x,y,w,LB;UC( g):x=g["x"].toInt(),y=g["y"].toInt(),w=g["w"].toInt(),LB=g["h"].toInt();}class HD{var w,LB;HD( g):w=g["w"].toInt(),LB=g["h"].toInt();} VC( g){return new TB.Future.value(nD.parse(g));}class AE extends UB{var cm;AE():super(v.WB([YB])); initialize(){cm=new EB<YB>(YB,l);} RB( g){var h=cm.get(g);h.value-= l.QB;if(h.value<0.0){g.iD(YB);g.bC();}}}class xB extends t{var eC;xB(this.eC);}class YB extends t{var value;YB(this.value);}class ZB extends t{var abs,angle;ZB(this.abs,this.angle);}class yB extends t{var time;yB(this.time);}class zB extends t{var aC;zB(this.aC);}const PB=600;const HB=720;class BE extends UB{var em;BE():super(v.WB([yB])); initialize(){em=new EB<yB>(yB,l);} RB( h){var g=em.get(h);g.time-= l.QB;if(g.time<0.0){h.TD();}}}const jB='player1';var WC=new LC.Random();class CE extends UB{var gC;var DB;CE():super(v.WB([xB,AB]).VD([YB])); initialize(){gC=new EB<xB>(xB,l);DB=new EB<AB>(AB,l);} RB( g){var k=gC.get(g);var h=DB.get(g).position;g.XC(new YB(k.eC));g.bC();iB(l,[new AB.LE(h.x,h.y,0.0),new ZB(0.4,0.0),new zB('bullet_${WC.nextInt(4)}'),new yB(2000.0)]);}}class DE extends UB{var DB;var SB;DE():super(v.WB([AB,ZB])); initialize(){DB=new EB<AB>(AB,l);SB=new EB<ZB>(ZB,l);} RB( k){var m=DB.get(k);var h=SB.get(k);var g=m.position;g.x=g.x-h.abs*LC.sin(h.angle)*l.QB;g.y=g.y-h.abs*LC.cos(h.angle)*l.QB;m.position=g;}}class u{final  i=new mC.Float32List(3);u( k, h, g){HC(k,h,g);} HC( k, h, g){i[0]=k;i[1]=h;i[2]=g;return this;} toString()=>'[${i[0]},${i[1]},${i[2]}]'; operator-()=>new u(-i[0],-i[1],-i[2]); operator-( g)=>new u(i[0]-g.i[0],i[1]-g.i[1],i[2]-g.i[2]); operator+( g)=>new u(i[0]+g.i[0],i[1]+g.i[1],i[2]+g.i[2]); operator/( h){var g=1.0/h;return new u(i[0]*g,i[1]*g,i[2]*g);} operator*( h){var g=h;return new u(i[0]*g,i[1]*g,i[2]*g);} operator[]( g)=>i[g]; operator[]=( h, g){i[h]=g;} get length{var g;g=(i[0]*i[0]);g+= (i[1]*i[1]);g+= (i[2]*i[2]);return LC.sqrt(g);} add( g){i[0]=i[0]+g.i[0];i[1]=i[1]+g.i[1];i[2]=i[2]+g.i[2];return this;}set x( g)=>i[0]=g;set y( g)=>i[1]=g;set z( g)=>i[2]=g; get x=>i[0]; get y=>i[1]; get z=>i[2];}class BB{final  i=new mC.Float32List(2);BB( h, g){HC(h,g);}BB.NE(); HC( h, g){i[0]=h;i[1]=g;return this;} toString()=>'[${i[0]},${i[1]}]'; operator-()=>new BB(-i[0],-i[1]); operator-( g)=>new BB(i[0]-g.i[0],i[1]-g.i[1]); operator+( g)=>new BB(i[0]+g.i[0],i[1]+g.i[1]); operator/( h){var g=1.0/h;return new BB(i[0]*g,i[1]*g);} operator*( h){var g=h;return new BB(i[0]*g,i[1]*g);} operator[]( g)=>i[g]; operator[]=( h, g){i[h]=g;} get length{var g;g=(i[0]*i[0]);g+= (i[1]*i[1]);return LC.sqrt(g);} add( g){i[0]=i[0]+g.i[0];i[1]=i[1]+g.i[1];return this;}set x( g)=>i[0]=g;set y( g)=>i[1]=g; get x=>i[0]; get y=>i[1];}